<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="金汇移动开发团队" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="stay hungry stay foolish">
<meta property="og:type" content="website">
<meta property="og:title" content="金汇移动开发团队">
<meta property="og:url" content="http://jhmobile.github.io/index.html">
<meta property="og:site_name" content="金汇移动开发团队">
<meta property="og:description" content="stay hungry stay foolish">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="金汇移动开发团队">
<meta name="twitter:description" content="stay hungry stay foolish">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jhmobile.github.io/">





  <title> 金汇移动开发团队 </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">金汇移动开发团队</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-admin">
          <a href="/admin" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            管理
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2018/11/06/解决cnpm私服无法安装react-native的问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/11/06/解决cnpm私服无法安装react-native的问题/" itemprop="url">
                  解决cnpm私服无法安装react-native的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T09:16:02+08:00">
                2018-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>需要在RN项目中安装react-native的依赖，由于项目package.json中既有对私有库的依赖，也有对第三方库的依赖，因此本地镜像地址使用的是私有cnpm仓库（2.10.0）。但是在安装react-native的时候，其中一个RN依赖的库metro无法安装，报<code>No compatible version found: metro</code>的错误，导致RN也安装失败。</p>
<h2 id="一些尝试"><a href="#一些尝试" class="headerlink" title="一些尝试"></a>一些尝试</h2><p>首先google一下错误信息，发现这也是个常见错误，但不同的库错误原因不一样，无法聚焦，所以没有继续深入看这个问题。</p>
<p>然后去cnpm私服的web端做了一个同步metro的操作<code>http://cnpm-web.jinhui365.cn/sync/metro</code>，发现报错<code>ER_TRUNCATED_WRONG_VALUE_FOR_FIELD: Incorrect string value:</code>，把这错误在google了一下，<a href="https://stackoverflow.com/questions/10957238/incorrect-string-value-when-trying-to-insert-utf-8-into-mysql-via-jdbc" target="_blank" rel="noopener">第一个结果</a>中的问题与这个错误非常一致，最高赞的回复也很明确，是因为mysql的某个字段使用的是utf8编码，只能支持3个字节，改成utf8mb4编码就可以了。</p>
<h2 id="处理步骤"><a href="#处理步骤" class="headerlink" title="处理步骤"></a>处理步骤</h2><h3 id="修改cnpm源码"><a href="#修改cnpm源码" class="headerlink" title="修改cnpm源码"></a>修改cnpm源码</h3><ol>
<li><p>将数据库编码和表的编码都改成utf8mb4</p>
</li>
<li><p>修改models/module.js文件，在module定义的options中增加<code>charset: &#39;utf8mb4&#39;</code>的配置</p>
</li>
<li><p>修改common/sequelize.js文件，config.database的定义中，增加<code>dialectOptions: {charset:&#39;utf8mb4&#39;},</code>的配置</p>
</li>
<li><p>在根目录执行<code>bin/nodejsctl stop</code>,<code>bin/nodejsctl start</code>重启服务。</p>
</li>
<li><p>尝试通过cnpm私服安装react-native，正常通过</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2018/10/31/React-Native-iOS本地私有库实践/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/31/React-Native-iOS本地私有库实践/" itemprop="url">
                  React Native iOS本地私有库实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-31T09:56:00+08:00">
                2018-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>Facebook官方对react-native（下面简称RN）在iOS端的集成方式为本地Pod库，这种方式有两个缺点：</p>
<ol>
<li><p>项目更新RN依赖版本较为繁琐，需要对项目中的node_modules文件夹进行文件操作，这种方式不利于模块化和版本管理</p>
</li>
<li><p>对pod形式的库项目支持不友好，pod库的依赖只能支持name+version的形式，无法支持本地源码形式的依赖</p>
</li>
</ol>
<p>综上，需要在公司私有Pod仓库中添加对RN的支持。</p>
<h2 id="一些尝试"><a href="#一些尝试" class="headerlink" title="一些尝试"></a>一些尝试</h2><h3 id="常规方式"><a href="#常规方式" class="headerlink" title="常规方式"></a>常规方式</h3><p>常规方式Pod库的常规操作方式为先lint再push，这种方式在RN上会遇到很多错误，解决了一批错误后最终停止在一个x86_64的错误上：<code>Undefined symbols for architecture x86_64</code>，这是一个比较常见的编译错误，但是尝试了很多方式后仍然无法解决。这里记录下关键问题，供后续参考：</p>
<ul>
<li>lint和push的时候需要增加几个关键选项：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--use-libraries		#不加会报一些c++库找不到的错误</span><br><span class="line">--allow-warnings	#不加只有warning也无法lint通过</span><br><span class="line">--verbose		#增加一些关键信息</span><br></pre></td></tr></table></figure>
<ul>
<li>如果对本地仓库有依赖，sources要指定本地私有仓库，不然默认是查找Cocoapods官方仓库</li>
</ul>
<h3 id="曲线方式"><a href="#曲线方式" class="headerlink" title="曲线方式"></a>曲线方式</h3><p>另外一个思路是考虑先把RN整体打成framework，再集成到Pod库中。这种方式最终停止在一个错误：<code>invalid bitcode signature</code>，跟上面的问题一样，没有搞定。</p>
<h3 id="手动操作Spec仓库方式"><a href="#手动操作Spec仓库方式" class="headerlink" title="手动操作Spec仓库方式"></a>手动操作Spec仓库方式</h3><p>在没有思路的时候，在google尝试搜索关键词<code>react-native  podspec</code>，发现一篇文章：<a href="https://imfong.com/post/Private-Pods-Add-react-native" target="_blank" rel="noopener">私有Pods集成react-native库</a>，里面分享通过<code>pod ipc spec</code>命令将.podspec文件转成.podspec.json格式文件，然后将代码和.podspec.json分别提交到代码仓库和Pod仓库的方式，绕过lint和push的常规步骤。</p>
<p>这里需要注意的是，代码提交到私有源码库和podspec提交到私有Pod库是互相独立的操作。可以只提交Podspec到私有Pod库，但是代码提交到到私有源码库有两个好处<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 内部网络更新速度快</span><br><span class="line">2. 可以修改代码后自定义版本</span><br></pre></td></tr></table></figure></p>
<p>尝试了一下，虽然遇到一些编译错误，但不是整体编译不过，而是一些RN内部类找不到，说明至少RN放到Pod仓库了。沿着这个思路往下探索，最终解决。</p>
<p>其中RN依赖了一些第三方库，包括folly、yoga、glog等，对于RN依赖的第三方库，处理原则是如果在官方Pod仓库没有对应的版本，都需要以私有Pod的方式提供。具体需要处理哪些库，需要根据当前RN版本来判断（例如Folly的2016.10.31.00在官方库没有，但是2016.09.26.00却能支持）。</p>
<h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><ol>
<li>去<code>https://github.com/facebook/react-native/tags</code>下载对应版本的RN源码包，解压缩后将源码提交到本地仓库<a href="mailto:`git@gitlab.jinhui365.cn" target="_blank" rel="noopener">`git@gitlab.jinhui365.cn</a>:mobile/react-native.git` master分支。这里需要注意的问题是要保证该版本所有文件都会提交，包括.开头的文和文件夹。</li>
<li>在gitlab上为新版本打一个tag，tag名称约定为v{版本号}，例如版本号为0.57.4，则tag名称为v0.57.4。</li>
<li>进入源码根目录，执行<code>pod ipc spec React.podspec &gt;&gt; React.podspec.json</code>。这里需要注意的是不要污染本地源码仓库，可以在另外一份源码拷贝上操作。</li>
<li><p>打开React.podspec.json文件，将source字段修改为本地的RN源码仓库地址和对应地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;source&quot;: &#123;</span><br><span class="line">    &quot;git&quot;: &quot;git@gitlab.jinhui365.cn:mobile/react-native.git&quot;,</span><br><span class="line">    &quot;tag&quot;: &quot;v0.57.4&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将修改后的React.podspec.json放到私有Pod仓库对应的目录下提交。例如<code>React/0.57.4/React.podspec.json</code></p>
</li>
<li>在源码根目录下，进入<code>ReactCommon/yoga</code>，执行<code>pod ipc spec yoga.podspec &gt;&gt; yoga.podspec.json</code></li>
<li><p>打开yoga.podspec.json，将source字段修改为本地的RN源码仓库地址和对应地址，并将source_files字段修改为<code>&quot;ReactCommon/yoga/**/*.{cpp,h}&quot;</code>，public_header_files字段修改为：<code>&quot;ReactCommon/yoga/yoga/{Yoga,YGEnums,YGMacros}.h&quot;</code></p>
</li>
<li><p>将修改后的yoga.podspec.json放到私有Pod仓库对应的目录下提交。例如<code>yoga/0.57.4.React/yoga.podspec.json</code></p>
</li>
<li><p>本地址行<code>pod repo update {仓库名}</code></p>
</li>
<li><p>至此，可以在项目中通过name+version的形式引用RN的pod依赖。</p>
</li>
</ol>
<h2 id="0-53-3的问题"><a href="#0-53-3的问题" class="headerlink" title="0.53.3的问题"></a>0.53.3的问题</h2><p>RN在0.53.3上有一些编译问题，李杨在<a href="https://jhmobile.github.io/2018/05/08/React-Native%E6%B7%B7%E7%BC%96%E5%AD%A6%E4%B9%A0/#iOS%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">React-Native混编学习#iOS环境搭建</a>  提到过相关解决方案，已按照该方案经将源码修改后tag为0.53.4。可以通过引用0.53.4来规避这些问题。</p>
<h2 id="私有库依赖私有库"><a href="#私有库依赖私有库" class="headerlink" title="私有库依赖私有库"></a>私有库依赖私有库</h2><p>金汇移动端目前负责的业务较多，不同的业务之间会复用工具库（如路由库、日志库等）。同一个业务功能，有可能需要在不同的App之间复用（如民工汇、支付SDK）。因此，依赖的路径为APP-&gt;业务库-&gt;非业务库。</p>
<p>iOS的依赖管理与Android不同。Android统一使用gradle文件来管理依赖，而iOS主项目使用Podfile管理，库项目使用podspec管理，并且库项目无法依赖本地文件。</p>
<p>因此新建了私有库<a href="http://gitlab.jinhui365.cn/iOS/PodLibTest" target="_blank" rel="noopener">PodLibTest</a>来测试了下，编译通过。这里记录下常见命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pod lib create PodLibTest	#创建pod库项目</span><br><span class="line">pod update --no-repo-update	#更新当前pod项目依赖</span><br><span class="line">pod repo update &#123;pod仓库名称&#125;	#更新本地pod仓库</span><br><span class="line">pod lib lint --use-libraries --allow-warnings --verbose --sources=git@gitlab.jinhui365.cn:iOS/JHJRSpecs.git,https://github.com/CocoaPods/Specs.git	#这些参数上面提到过，比较关键</span><br><span class="line">pod repo push JHJR PodLibTest.podspec  --use-libraries --allow-warnings --verbose	#同样关注下参数</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>Cocoapods在依赖管理方面不够完善，提升了iOS工程化的难度等级。因此需要iOS工程师对相关领域知识研究地更深入，才能达到与Android同水平的工程化程度。</p>
</li>
<li><p>面对非常见疑难问题，通过简单的关键词搜索可能不太好找到解决方案。需要从两个方面着手，一方面多尝试关键词组合，找到和你遇到同样问题的人写的文章或帖子；一方面深入研究官方文档货项目源码，从原理层着手分析问题。</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2018/05/08/React-Native混编学习/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/08/React-Native混编学习/" itemprop="url">
                  React-Native混编学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-08T14:11:36+08:00">
                2018-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="React-Native混编学习"><a href="#React-Native混编学习" class="headerlink" title="React-Native混编学习"></a>React-Native混编学习</h1><p>本篇主要涉及的是App和RN的混合开发环境搭建，对于基本的RN环境搭建请自行查阅<a href="https://reactnative.cn/docs/0.51/getting-started.html" target="_blank" rel="noopener">文档</a>。</p>
<p>这里需要着重注意的是全局依赖：</p>
<ul>
<li>node v8.1.3（nvm管理）</li>
<li>react-native-cli 0.53.3(npm全局包)</li>
<li>nrm(npm全局包，主要是为了管理npm源，切换npm源为taobao)</li>
<li>gulp(npm全局包，主要是打包zip压缩)</li>
</ul>
<blockquote>
<p>最好的方式是使用react-native init生成一个新的RN项目，参考它的package.json依赖。这里我使用的是<code>&quot;react&quot;: &quot;16.2.0&quot;</code> <code>&quot;react-native&quot;: &quot;0.53.3&quot;</code></p>
</blockquote>
<h2 id="APP配合"><a href="#APP配合" class="headerlink" title="APP配合"></a>APP配合</h2><ul>
<li>环境搭建<ul>
<li>依赖如何引入</li>
</ul>
</li>
<li>接口定义<ul>
<li>获取当前用户信息</li>
<li>获取当前环境状态</li>
<li>结束RN activity</li>
<li>路由跳转结构定义（互相跳转的接口）</li>
</ul>
</li>
<li>RN热更部分完善（Android和iOS）<ul>
<li>资源包地址重定义</li>
<li>热更代码完善</li>
</ul>
</li>
<li>RN开发调试<ul>
<li>兼容开发环境，方便我们调试（Bundle地址，开发模式启动）</li>
</ul>
</li>
<li>打包脚本修改<ul>
<li>依赖如何注入</li>
<li>编译问题解决</li>
</ul>
</li>
<li>部分常量配置<ul>
<li>RN服务地址常量</li>
<li>RN主组件名称</li>
<li>Bundle地址</li>
</ul>
</li>
<li>RN路由定义</li>
<li>登陆验证问题</li>
</ul>
<h2 id="android环境搭建"><a href="#android环境搭建" class="headerlink" title="android环境搭建"></a>android环境搭建</h2><h3 id="基础部分"><a href="#基础部分" class="headerlink" title="基础部分"></a>基础部分</h3><ul>
<li>RNApp嵌入原生</li>
<li>原生跳转RN路由</li>
<li>原生和RN的通信</li>
<li>RN资源管理</li>
<li>RN开发调试</li>
<li>其他问题<ul>
<li>原生加载RN白屏问题</li>
<li>回退问题</li>
</ul>
</li>
</ul>
<h3 id="RNApp嵌入原生"><a href="#RNApp嵌入原生" class="headerlink" title="RNApp嵌入原生"></a>RNApp嵌入原生</h3><h4 id="1-依赖引入"><a href="#1-依赖引入" class="headerlink" title="1. 依赖引入"></a>1. 依赖引入</h4><p>引入<code>node_modules/react-native/android</code></p>
<ul>
<li><p>主build.gradle 添加</p>
<pre><code>maven {
    // All of React Native (JS, Android binaries) is installed from npm
    url &quot;$rootDir/../node_modules/react-native/android&quot;
}
</code></pre></li>
<li>app/build.gradle 添加 <code>compile &quot;com.facebook.react:react-native:0.53.3&quot;</code><blockquote>
<p>后需改为我们的android包管理</p>
</blockquote>
</li>
</ul>
<h4 id="2-MyApplication类继承ReactApplication"><a href="#2-MyApplication类继承ReactApplication" class="headerlink" title="2. MyApplication类继承ReactApplication"></a>2. MyApplication类继承ReactApplication</h4><ul>
<li>onCreate中添加<code>SoLoader.init(this, false);</code></li>
<li><p>Override <code>public ReactNativeHost getReactNativeHost() {
  return mReactNativeHost;
}</code>代码如下：</p>
<pre><code>private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
  @Nullable
  @Override
  protected String getJSBundleFile() { // 定义RN Bundle文件地址
    return super.getJSBundleFile(); // 默认地址为assets/index.android.bundle
  }

  @Override
  public boolean getUseDeveloperSupport() { // 定义DEBUG模式
      return BuildConfig.DEBUG;
  }

  @Override
  protected List&lt;ReactPackage&gt; getPackages() { // RN包载入
      return Arrays.&lt;ReactPackage&gt;asList(
              new MainReactPackage(),
              new CommPackage(); // 载入公共包，见原生和RN通信
      );
  }
};
</code></pre></li>
</ul>
<blockquote>
<p>后需重新定义Bundle文件地址，使之能够热更。</p>
</blockquote>
<h4 id="3-RNActivity编写"><a href="#3-RNActivity编写" class="headerlink" title="3. RNActivity编写"></a>3. RNActivity编写</h4><pre><code>public class MyReactActivity extends ReactActivity {

  public Bundle getBundle() { // 获取props入参
      return getIntent().getExtras();
  }

  protected @Nullable String getMainComponentName() { // 定义RN组件名称
      return &quot;MyReactNativeApp&quot;;
  }

  @Override
  protected ReactActivityDelegate createReactActivityDelegate() { // 通过getLaunchOptions传值
      return new ReactActivityDelegate(this, getMainComponentName()) { 
          @Nullable
          @Override
          protected Bundle getLaunchOptions() {
              return getBundle();
          }
      };
  }
</code></pre><p>  }</p>
<p>至此，通过startActivity就能够正常打开一个RNApp了。</p>
<h3 id="原生跳转RN路由"><a href="#原生跳转RN路由" class="headerlink" title="原生跳转RN路由"></a>原生跳转RN路由</h3><p>这里跳转可以有很多方式，不过最根本的是如何通过原生将要跳转的路由传递给RN。<br>主要分为两大类方式：（见本篇原生和RN通信）</p>
<ul>
<li>主动传递</li>
<li>被动传递</li>
</ul>
<p>这里我采用的是主动传递中的Props传递。</p>
<p>在原生开启RNApp的时候，可以传递一个Bundle作为最初的Props，路由及部分参数信息通过这个Bundle带给RN。</p>
<p><strong>Android部分</strong></p>
<ul>
<li><p>ReactActivityDelegate类</p>
<pre><code>protected void loadApp(String appKey) {
  if (mReactRootView != null) {
    throw new IllegalStateException(&quot;Cannot loadApp while app is already running.&quot;);
  }
  mReactRootView = createRootView();
  mReactRootView.startReactApplication(
    getReactNativeHost().getReactInstanceManager(),
    appKey,
    getLaunchOptions()); // 在这里有个getLaunchOptions方法，就是传递Bundle的地方
  getPlainActivity().setContentView(mReactRootView);
}

protected @Nullable Bundle getLaunchOptions() {
  return null;
}
</code></pre></li>
<li>MyReactActivity类<br>我们这里通过在MyReactActivity类里重载getLaunchOptions方法，传递Bundle（参考RNApp嵌入原生代码）</li>
</ul>
<p><strong>RN部分</strong><br>  RN这里采用了<code>react-native-router-flux</code>作为路由管理插件。这里需要注意的是版本问题，测试发现<code>&quot;react-native-router-flux&quot;: &quot;^4.0.0-beta.25&quot;</code>， <code>&quot;react-navigation&quot;: &quot;^1.0.0-beta.22&quot;</code>可用。</p>
<p>相关代码如下：</p>
<pre><code>import React from &apos;react&apos;;
import { Router, Scene, Actions } from &apos;react-native-router-flux&apos;;
import { getUserInfo, finishActivity } from &apos;./communication&apos;

import PageOne from &apos;./modules/PageOne&apos;
import PageTwo from &apos;./modules/PageTwo&apos;
import PageThree from &apos;./modules/PageThree&apos;
import PageFour from &apos;./modules/PageFour&apos;

export default class App extends React.Component {
  constructor(props) {
    super(props);
    console.log(&quot;RN启动&quot;);
  }

  componentDidMount(){
    const rnKey = this.props.rnKey || &quot;PageOne&quot;;
    Actions.reset(rnKey, this.props);
  }

  // 导航栏回退方法
  onBack () {
    let popRouter = Actions.pop();
    !popRouter &amp;&amp; finishActivity();
  }

  render() {
    return (
      &lt;Router&gt;
        &lt;Scene key=&quot;root&quot; hideNavBar={true}&gt;
          &lt;Scene key=&quot;PageOne&quot; back={true} hideNavBar={false} component={PageOne} title=&quot;PageOne&quot; onBack={() =&gt; this.onBack()}/&gt;
          &lt;Scene key=&quot;PageTwo&quot; back={true} hideNavBar={false} component={PageTwo} title=&quot;PageTwo&quot; onBack={() =&gt; this.onBack()}/&gt;

          {/* 用户信息获取，用户已登陆 */}
          &lt;Scene key=&quot;PageThree&quot; back={true} hideNavBar={false} component={PageThree} title=&quot;PageThree&quot; onBack={() =&gt; this.onBack()}/&gt;
          &lt;Scene key=&quot;PageFour&quot; back={true} hideNavBar={false} component={PageFour} title=&quot;PageFour&quot; onBack={() =&gt; this.onBack()}/&gt;
        &lt;/Scene&gt;
      &lt;/Router&gt;
    )
  }
}
</code></pre><h3 id="原生和RN的通信"><a href="#原生和RN的通信" class="headerlink" title="原生和RN的通信"></a>原生和RN的通信</h3><p>上面说道通信分为两种，主动传递和被动传递。这里的主动/被动是以原生为参照。具体的可以参考<a href="https://reactnative.cn/docs/0.51/communication-android.html#content" target="_blank" rel="noopener">和原生端通信</a>，这里只贴关键部分的代码。如下：</p>
<p><strong>Android部分</strong></p>
<ul>
<li><p>Package类</p>
<pre><code>package xxx;

import com.facebook.react.ReactPackage;
import com.facebook.react.bridge.NativeModule;
import com.facebook.react.bridge.ReactApplicationContext;
import com.facebook.react.uimanager.ViewManager;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

public class CommPackage implements ReactPackage {
    public CommModule mModule;

    /**
    * 创建Native Module
    * @param reactContext
    * @return
    */
    @Override
    public List&lt;NativeModule&gt; createNativeModules(ReactApplicationContext reactContext) {
        List&lt;NativeModule&gt; modules = new ArrayList&lt;&gt;();
        mModule = new CommModule(reactContext);
        modules.add(mModule);
        return modules;
    }

    @Override
    public List&lt;ViewManager&gt; createViewManagers(ReactApplicationContext reactContext) {
        return Collections.emptyList();
    }
}
</code></pre></li>
<li><p>module类</p>
<pre><code>public class CommModule extends ReactContextBaseJavaModule {

    private ReactApplicationContext mContext;
    public static final String MODULE_NAME = &quot;commModule&quot;;
    public static final String EVENT_NAME = &quot;nativeCallRn&quot;;
    public static final String EVENT_NAME1 = &quot;getPatchImgs&quot;;
    /**
    * 构造方法必须实现
    * @param reactContext
    */
    public CommModule(ReactApplicationContext reactContext) {
        super(reactContext);
        this.mContext = reactContext;
    }

    /** 主动传递
    * Native调用RN
    * @param msg
    */
    public void nativeCallRn(String msg) {
        mContext.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class)
                .emit(EVENT_NAME,msg);
    }

    /**
    * Callback 方式
    * rn调用Native,并获取返回值
    * @param msg
    * @param callback
    */
    @ReactMethod
    public void rnCallNativeFromCallback(String msg, Callback callback) {

        // 1.处理业务逻辑...
        String result = &quot;处理结果：&quot; + msg;
        // 2.回调RN,即将处理结果返回给RN
        callback.invoke(result);
    }

    /**
    * Promise
    * @param msg
    * @param promise
    */
    @ReactMethod
    public void rnCallNativeFromPromise(String msg, Promise promise) {

        Log.e(&quot;---&quot;,&quot;adasdasda&quot;);
        // 1.处理业务逻辑...
        String result = &quot;处理结果：&quot; + msg;
        // 2.回调RN,即将处理结果返回给RN
        promise.resolve(result);
    }

    /**
    * 向RN传递常量
    */
    @Nullable
    @Override
    public Map&lt;String, Object&gt; getConstants() {
        Map&lt;String,Object&gt; params = new HashMap&lt;&gt;();
        params.put(&quot;Constant&quot;,&quot;我是常量，传递给RN&quot;);
        return params;
    }

    @ReactMethod
    public void startActivityFromJS(String path, ReadableMap params){
        try{
            Activity currentActivity = getCurrentActivity();

            if(null!=currentActivity){
                Map intentParams = ((ReadableNativeMap) params).toHashMap();

                &lt;!--startActivity--&gt;
            }
        }catch(Exception e){
            throw new JSApplicationIllegalArgumentException(
                    &quot;不能打开Activity : &quot;+e.getMessage());
        }
    }

    @ReactMethod
    public void dataToJS(Callback successBack, Callback errorBack){
        try{
            Activity currentActivity = getCurrentActivity();
            String result = currentActivity.getIntent().getStringExtra(&quot;data&quot;);

            successBack.invoke(result);
        }catch (Exception e){
            errorBack.invoke(e.getMessage());
        }
    }
}
</code></pre></li>
</ul>
<p>最后在MyApplication中注入，查看上面嵌入RNApp部分的【载入公共包，见原生和RN通信】注释。</p>
<p><strong>RN部分</strong><br>RN部分正常引用调用就好，代码如下：</p>
<pre><code>import { NativeModules } from &apos;react-native&apos;;

const { commModule } = NativeModules;

export function startActivity (appPath, params = {}) {
  if(appPath) {
    commModule.startActivityFromJS(appPath, params);
  }
}

export function finishActivity () {
  commModule.activityFinish();
}

export function getUserInfo() {
  return commModule.getUserInfo()
}

export function getEnv() {}

// test
export function rnCallNativeFromCallback(msg, callback) {
  commModule.rnCallNativeFromCallback(msg, callback);
}

export function rnCallNativeFromPromise(msg) {
  return commModule.rnCallNativeFromPromise(msg);
}

export function getConstans() {
  console.log(commModule.test)
}
</code></pre><h3 id="RN资源管理"><a href="#RN资源管理" class="headerlink" title="RN资源管理"></a>RN资源管理</h3><p>测试发现如果将打包的Bundle文件和资源文件放到统一目录下，就可以正常引用资源。<br>参考命令<code>react-native bundle --platform android --dev false  --entry-file index.js  --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/assets</code></p>
<p>有需要做热更的可以将资源放到SD卡中，只需要指定以下Bundle文件路径，将资源和Bundle文件放到一起就好。</p>
<h3 id="RN开发调试"><a href="#RN开发调试" class="headerlink" title="RN开发调试"></a>RN开发调试</h3><p>这里只说我的调试方式，更详细的请查阅<a href="https://reactnative.cn/docs/0.51/debugging.html#content" target="_blank" rel="noopener">调试文档</a>。</p>
<ol>
<li>在<code>AndroidManifest.xml</code>中添加<code>&lt;activity android:name=&quot;com.facebook.react.devsupport.DevSettingsActivity&quot; /&gt;</code>启用调试模式。</li>
<li>通过<code>npm start</code>启动RN服务，即<code>node node_modules/react-native/local-cli/cli.js start</code>。</li>
<li>真机安装APP进入RNApp界面，摇动手机可以打开开发者列表，通过设置Dev Host可以连接RN服务。Reload可以重载RNApp。</li>
<li>通过在Android Studio输出中检索React可以查看RN的输出（包括console）。</li>
</ol>
<blockquote>
<p>这里的调试基于HOST Bundle获取方式上，也就是说你的Bundle获取地址应当是默认的<code>super.getJSBundleFile()</code>。</p>
</blockquote>
<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><ol>
<li><p>原生加载RN白屏问题<br>白屏是因为加载Bundle文件过慢导致的，这个网上有很多的解释了。这里我的解决办法是在App开启动画的Activity里执行了一次加载。</p>
<pre><code>private void preLoadReactNative() {
    // 1.创建ReactRootView
    ReactRootView rootView = new ReactRootView(this);
    rootView.startReactApplication(
            ((ReactApplication) getApplication()).getReactNativeHost().getReactInstanceManager(),
            &quot;MyReactNativeApp&quot;,
            null);
}
</code></pre></li>
<li><p>返回按键问题<br>这里的返回键分为两种，一种是手机硬件后退按键，另一种是导航栏后退按键。手机后退这里无需做处理,导航栏后退如下处理：</p>
<ul>
<li><p>RN</p>
<pre><code>onBack () {
  let popRouter = Actions.pop();
  !popRouter &amp;&amp; finishActivity(); // 判断是否为RN首页，返回原生上个页面。
}
</code></pre></li>
<li><p>原生见本篇<code>finishActivity</code>方法。</p>
</li>
</ul>
</li>
</ol>
<p><strong>部分代码参考<a href="https://github.com/songxiaoliang/ReactNativeApp" target="_blank" rel="noopener">ReactNativeApp</a>项目</strong></p>
<h2 id="iOS环境搭建"><a href="#iOS环境搭建" class="headerlink" title="iOS环境搭建"></a>iOS环境搭建</h2><p>基于Android环境搭建，iOS部署大同小异，这里仅介绍不同的部分。</p>
<h3 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h3><p>修改Podfile，添加如下内容：(环境配置参考<a href="https://reactnative.cn/docs/0.51/integration-with-existing-apps.html#content" target="_blank" rel="noopener">集成到现有原生应用</a>)</p>
<pre><code># &apos;node_modules&apos;目录一般位于根目录中
# 但是如果你的结构不同，那你就要根据实际路径修改下面的`:path`
pod &apos;React&apos;, :path =&gt; &apos;../node_modules/react-native&apos;, :subspecs =&gt; [
    &apos;Core&apos;,
    &apos;CxxBridge&apos;, # 如果RN版本 &gt;= 0.45则加入此行
    &apos;DevSupport&apos;, # 如果RN版本 &gt;= 0.43，则需要加入此行才能开启开发者菜单
    # 这里注意一下!!!添加这些解决react-navigation的native module not be null的问题
    &apos;ART&apos;,
    &apos;RCTActionSheet&apos;,
    &apos;RCTGeolocation&apos;,
    &apos;RCTImage&apos;,
    &apos;RCTNetwork&apos;,
    &apos;RCTPushNotification&apos;,
    &apos;RCTSettings&apos;,
    &apos;RCTText&apos;,
    &apos;RCTVibration&apos;,
    &apos;RCTWebSocket&apos;, # 这个模块是用于调试功能的
    &apos;RCTLinkingIOS&apos;,
]
# 如果你的RN版本 &gt;= 0.42.0，则加入下面这行
pod &quot;yoga&quot;, :path =&gt; &quot;../node_modules/react-native/ReactCommon/yoga&quot;

# 如果RN版本 &gt;= 0.45则加入下面三个第三方编译依赖
pod &apos;DoubleConversion&apos;, :podspec =&gt; &apos;../node_modules/react-native/third-party-podspecs/DoubleConversion.podspec&apos;
pod &apos;GLog&apos;, :podspec =&gt; &apos;../node_modules/react-native/third-party-podspecs/GLog.podspec&apos; // 这里修改glog为GLog
pod &apos;Folly&apos;, :podspec =&gt; &apos;../node_modules/react-native/third-party-podspecs/Folly.podspec&apos;

end
</code></pre><p>然后运行pod install安装依赖</p>
<blockquote>
<p>这里是离线的包，怎么去合并到打包流程？（可以通过npm install去解决，不过比较麻烦）</p>
</blockquote>
<h3 id="RNApp嵌入原生-1"><a href="#RNApp嵌入原生-1" class="headerlink" title="RNApp嵌入原生"></a>RNApp嵌入原生</h3><p>和安卓一样，需要写一个类似于activity的壳子供给RN。</p>
<p><strong>ReactView.h</strong></p>
<pre><code>#import &lt;Foundation/Foundation.h&gt;

@interface ReactView : UIViewController

@end
</code></pre><p><strong>ReactView.m</strong></p>
<pre><code>#import &quot;ReactView.h&quot;
#import &lt;React/RCTRootView.h&gt;
#import &lt;React/RCTBridgeModule.h&gt;
#import &quot;commModule.h&quot; # 这里是RN和原生交互所需要的一些方法，可先去掉

@interface ReactView()&lt;UINavigationBarDelegate&gt;
@end
@implementation ReactView

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.

    # 这里的http和localhost要给一下权限
    NSString * strUrl = @&quot;http://localhost:8081/index.bundle?platform=ios&amp;dev=true&quot;;    
    NSURL * jsCodeLocation = [NSURL URLWithString:strUrl];

    # 除http之外，和安卓一样，也可以通过bundle
    RCTRootView * rootView = [[RCTRootView alloc] 
                                initWithBundleURL:jsCodeLocation
                                moduleName:@&quot;MyReactNativeApp&quot;
                                initialProperties:nil
                                launchOptions:nil];
    self.view = rootView;
}

#pragma mark - 导航条处理，取消RN的导航栏
- (void)navigationController:(UINavigationController *)navigationController willShowViewController:(UIViewController *)viewController animated:(BOOL)animated {
    [navigationController setNavigationBarHidden:YES animated:YES];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
</code></pre><p><strong>Bundle地址重定义</strong></p>
<pre><code>NSString *cachePath = @&quot;XXX&quot;;
cachePath = [cachePath stringByAppendingPathComponent:@&quot;index.ios.bundle&quot;];
NSURL *jsCodeLocation = [NSURL URLWithString:cachePath];
</code></pre><p>中间遇到了几个编译问题导致build失败。问题与解决方法如下：</p>
<ul>
<li><p><a href="https://stackoverflow.com/questions/48705250/react-native-ios-could-not-build-module-yoga-algorithm-file-not-found" target="_blank" rel="noopener">React Native iOS: Could not build module ‘yoga’: ‘algorithm’ file not found</a></p>
</li>
<li><p>RCTReconnectingWebSocket.h文件的#import &lt;fishhook/fishhook.h&gt; 显示error: ‘fishhook/fishhook.h’ file not found</p>
<pre><code>&quot;scripts&quot;: {
    &quot;postinstall&quot;: &quot;sed -i &apos;&apos; &apos;s#&lt;fishhook/fishhook.h&gt;#\&quot;fishhook.h\&quot;#g&apos; ./node_modules/react-native/Libraries/WebSocket/RCTReconnectingWebSocket.m&quot;
}
</code></pre></li>
<li>resolveRCTValueAnimatedNode<br>  <code>sed -i &#39;&#39; &#39;s/#import &lt;RCTAnimation\\/RCTValueAnimatedNode.h&gt;/#import \&quot;RCTValueAnimatedNode.h\&quot;/&#39; ./node_modules/react-native/Libraries/NativeAnimation/RCTNativeAnimatedNodesManager.h</code></li>
</ul>
<p>这样配个正常的iOS跳转地址，就可以正常跳转到RN了。这里的RN界面最好用一件简单的hello world测试下。</p>
<blockquote>
<p>编译问题怎么合到打包代码中？</p>
</blockquote>
<h3 id="原生和RN的通信-1"><a href="#原生和RN的通信-1" class="headerlink" title="原生和RN的通信"></a>原生和RN的通信</h3><p>通信一样是原生提供一下方法，可供给RN调用，直接上代码。</p>
<p><strong>commModule.h</strong></p>
<pre><code>#import &lt;Foundation/Foundation.h&gt;
#import &lt;React/RCTBridgeModule.h&gt;

@interface commModule : NSObject &lt;RCTBridgeModule&gt;

@end
</code></pre><p><strong>commModule.m</strong></p>
<pre><code>#import &quot;commModule.h&quot;
#import &lt;React/RCTConvert.h&gt;

@implementation commModule

RCT_EXPORT_MODULE();

RCT_EXPORT_METHOD(rnCallNativeFromCallback:(NSString *)msg callback:(RCTResponseSenderBlock)callback)
{
    NSString *result = [@&quot;处理结果:&quot; stringByAppendingString:msg];
    callback(@[[NSNull null], result]);
}

RCT_REMAP_METHOD(rnCallNativeFromPromise, msg:(NSString *)msg
                findEventsWithResolver:(RCTPromiseResolveBlock)resolve
                rejecter:(RCTPromiseRejectBlock)reject)
{
    NSString *result = [@&quot;处理结果:&quot; stringByAppendingString:msg];
    resolve(result);
}

RCT_REMAP_METHOD(getUserInfo, msg:(NSDictionary *)msg
                resolver:(RCTPromiseResolveBlock)resolve
                rejecter:(RCTPromiseRejectBlock)reject)
{

    resolve(@{@&quot;name&quot;: @&quot;iOS&quot;});
}

RCT_EXPORT_METHOD(startActivityFromJS:(NSString *)path params:(NSDictionary *)params)
{
    # 路由跳转，注意UI主线程
}

RCT_EXPORT_METHOD(activityFinish)
{
    # 结束RN finish，注意UI主线程
}

- (NSDictionary *)getConstants
{
    int n = arc4random_uniform(100);
    return @{ @&quot;test&quot;: @&quot;test&quot; };
}

@end
</code></pre><p>这样就可以在RN端调用了，调用方法和Android一样。</p>
<h3 id="RN资源管理-1"><a href="#RN资源管理-1" class="headerlink" title="RN资源管理"></a>RN资源管理</h3><p>测试发现如果将打包的Bundle文件和资源文件放到统一目录下，就可以正常引用资源。<br>参考命令<code>react-native bundle --platform ios --dev false  --entry-file index.ios.js  --bundle-output ReactNative/ios/index.ios.bundle --assets-dest ReactNative/ios</code></p>
<p>有需要做热更的可以指定以下Bundle文件路径，将资源和Bundle文件放到一起就好。</p>
<h3 id="RN开发调试-1"><a href="#RN开发调试-1" class="headerlink" title="RN开发调试"></a>RN开发调试</h3><p>这里只说我的调试方式，更详细的请查阅<a href="https://reactnative.cn/docs/0.51/debugging.html#content" target="_blank" rel="noopener">调试文档</a>。</p>
<ol>
<li>通过<code>initWithBundleURL</code>方式连接本地RN服务</li>
<li>通过<code>npm start</code>启动RN服务，即<code>node node_modules/react-native/local-cli/cli.js start</code>。</li>
<li>command + R可以在RN界面Reload RN</li>
<li>通过在Xcode输出中检索React可以查看RN的输出（包括console）。</li>
</ol>
<h2 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h2><ul>
<li>android项目依赖maven <code>{ url &quot;$rootDir/../node_modules/react-native/android&quot; }</code></li>
<li>iOS项目依赖怎么合并到打包脚本中</li>
<li>iOS编译问题如何在流程中解决</li>
<li>登陆验证问题</li>
</ul>
<h2 id="资源地址"><a href="#资源地址" class="headerlink" title="资源地址"></a>资源地址</h2><p>服务器172.16.192.249/mobile_node/魏晓峰/RN</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/10/25/ESLint入门与实践初步/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/25/ESLint入门与实践初步/" itemprop="url">
                  ESLint入门与实践初步
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-25T10:51:09+08:00">
                2017-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ESLint-入门与实践"><a href="#ESLint-入门与实践" class="headerlink" title="ESLint 入门与实践"></a>ESLint 入门与实践</h1><hr>
<h2 id="一、主流JavaScript检查调研"><a href="#一、主流JavaScript检查调研" class="headerlink" title="一、主流JavaScript检查调研"></a>一、主流JavaScript检查调研</h2><p>JSLint、JSHint、JSCS、ESLint 四种工具有相同的基本方式工作。它们都有一套用户分析、报告js文件错误的规则。他们都可以通过npm安装、通过命令行使用。下面比对一下各自的优缺点</p>
<h3 id="JSLint"><a href="#JSLint" class="headerlink" title="JSLint"></a>JSLint</h3><p>JSLint 是其中最老的工具。在2002年 <code>Douglas Crockford</code>,业内尊称“道爷”开发了该工具，根据其经验，强制使用js语言中精粹的部分。如果你同意这些精粹，JSLint能成为一个好的工具。</p>
<p>优点</p>
<ul>
<li>参数配置完成，可以直接使用</li>
</ul>
<p>缺点</p>
<ul>
<li>JSLint 不存在配置文件，如果想改变参数设置，那就存在问题</li>
<li>有限的配置选项，许多规则不能禁掉</li>
<li>不能增加个性化规则</li>
<li>很难弄清楚哪个规则引起的错误</li>
</ul>
<h3 id="JSHint"><a href="#JSHint" class="headerlink" title="JSHint"></a>JSHint</h3><p>作为一个可配置的JSLint版本而被开发出来</p>
<p>优点</p>
<ul>
<li>大多是参数可以配置</li>
<li>支持配置文件，在大项目中容易使用</li>
<li>已经支持需要类库，像jQuery、QUnit、NodeJS、Mocha等</li>
<li>支持基本的ES6</li>
</ul>
<p>缺点</p>
<ul>
<li>难于知道哪个规则产生错误</li>
<li>存在两类选项：强制选项和松散选项。使得配置有些混乱</li>
<li>不支持自定义规则</li>
</ul>
<h3 id="JSCS"><a href="#JSCS" class="headerlink" title="JSCS"></a>JSCS</h3><p>JSCS是一个代码风格检查器。这意味着它仅仅匹配代码格式的问题，不匹配潜在的bugs、errors。因此，跟其他工具相比缺少灵活性，但是如果你仅仅强制检查代码风格，JSCS也是一个好的工具。</p>
<p>优点</p>
<ul>
<li>支持自定义报告，更容易与其他工具集成</li>
<li>如果你遵循一种可用的代码风格，配置项和准备好的配置文件使其容易启动</li>
<li>在报告中存在标记包含规则名字，所以很容易指出哪个规则造成了错误</li>
<li>通过自定义插件进行拓展</li>
</ul>
<p>缺点</p>
<ul>
<li>仅仅检查代码风格的问题。JSCS不检查潜在存在的bugs，例如不适用的变量、偶然的全局变量等等</li>
<li>四个工具中最慢，但是在使用中不是一个问题</li>
</ul>
<h3 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h3><p>ESLint是最新出来的工具，是一个用来识别 ECMAScript 并且按照规则给出报告的代码检测工具，使用它可以避免低级错误和统一代码的风格。它被设计的容易拓展、拥有大量的自定义规则、容易的通过插件来安装。它给出准确的输出，而且包括规则名，这样可以知道哪个规则造成了错误。</p>
<p>优点</p>
<ul>
<li>灵活：任何规则都可以开启闭合，以及有些规则有些额外配置</li>
<li>很容易拓展和有需要可用插件</li>
<li>容易理解产出</li>
<li>包含了在其他检查器中不可用的规则，使得ESLint在错误检查上更有用</li>
<li>支持ES6，唯一支持JSX的工具</li>
<li>支持自定义报告</li>
</ul>
<p>缺点</p>
<ul>
<li>需要一些配置</li>
<li>速度慢，但不是主要问题</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>最终推荐 ESLint。JSLint是严格和不可配置的，而JSHint缺少拓展机制。JSCS如果仅仅用于代码风格检验是一个好的选择，但是ESLint不仅可以进行代码风格的检验，而且可以检查代码中的bug和其他问题。<br>如果使用ES6，ESLint也是明显的选择。在上面提到的工具中，ESLint对ES6支持的最广泛。</p>
<h2 id="二、ESLint-安装"><a href="#二、ESLint-安装" class="headerlink" title="二、ESLint 安装"></a>二、ESLint 安装</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre><code>npm i -g eslint
npm install eslint --save-dev
</code></pre><h3 id="初始化配置文件"><a href="#初始化配置文件" class="headerlink" title="初始化配置文件"></a>初始化配置文件</h3><p>接下来新建一个配置文件<code>.eslintrc.js</code>，或者执行<code>eslint --init</code>来自动生成。这条命令会类似<code>npm init</code>出现一系列对话问答</p>
<p><img src="http://static.zybuluo.com/hellobeifeng1314/q618bns1h9jf8cnh19d13b1m/eslint_init.png" alt="eslint_init.png-178.4kB"></p>
<p>通过结果产生基本的配置内容，内容如下（不包含注释，注释是我写的）</p>
<pre><code>module.exports = {
    &quot;env&quot;: {
        &quot;browser&quot;: true
    },
    &quot;extends&quot;: &quot;eslint:recommended&quot;,
    &quot;rules&quot;: {
        // 强制使用一致的缩进: error级别，四空格
        &quot;indent&quot;: [
            &quot;error&quot;,
            4
        ],
        // 强制使用unix风格的换行：error级别
        &quot;linebreak-style&quot;: [
            &quot;error&quot;,
            &quot;unix&quot;
        ],
        // 使用双引号“”，而不是‘’
        &quot;quotes&quot;: [
            &quot;error&quot;,
            &quot;double&quot;
        ],
        // 强制行位分号
        &quot;semi&quot;: [
            &quot;error&quot;,
            &quot;always&quot;
        ]
    }
};
</code></pre><p>还可以选择在<code>package.json</code> 中设置 <code>eslintConfig</code>属性。但是不推荐。</p>
<p>个人建议, 使用单独的 <code>.eslintrc.*</code> 配置文件,这样别人一看代码结构就知道使用了 eslint 来校验代码，最好是js文件,json文件是不支持注释的。</p>
<blockquote>
<p>默认情况下，eslint 会在所有父级文件夹中寻找配置文件，一直找到根目录为止。如果希望 eslint 不要继续往外寻找配置文件了则这样配置：<code>&quot;root&quot;: true</code></p>
</blockquote>
<h3 id="eslintignore-忽略文件"><a href="#eslintignore-忽略文件" class="headerlink" title=".eslintignore 忽略文件"></a>.eslintignore 忽略文件</h3><p>你可以通过在项目根目录创建一个 <code>.eslintignore</code> 文件告诉 ESLint 去忽略特定的文件和目录。</p>
<ul>
<li>以 <code>#</code> 开头的行被当作注释，不影响忽略模式。 </li>
<li>路径是相对于 <code>.eslintignore</code> 的位置或当前工作目录。这也会影响通过<code>–ignore-pattern</code>传递的路径。 </li>
<li>忽略模式同 <code>.gitignore</code> 规范 </li>
<li>除了 <code>.eslintignore</code> 文件中的模式，ESLint总是默认忽略 <code>/node_modules/</code> 和 <code>/bower_components/</code>中的文件。</li>
</ul>
<h2 id="三、ESLint-配置"><a href="#三、ESLint-配置" class="headerlink" title="三、ESLint 配置"></a>三、ESLint 配置</h2><h3 id="配置执行环境"><a href="#配置执行环境" class="headerlink" title="配置执行环境"></a>配置执行环境</h3><p>配置文件中可以自由的指定执行环境，浏览器 或 <code>nodejs</code>。可以同时指定多个！</p>
<pre><code>module.exports = {
  env: {
    browser: true,
    node: true,
    es6: true
  },
};
</code></pre><h3 id="配置全局变量"><a href="#配置全局变量" class="headerlink" title="配置全局变量"></a>配置全局变量</h3><p>只配置环境是远远不够的，不同环境之间还会有不同环境变量。ESLint 可以在配置文件或注释中指定额外的全局变量，<code>false</code>表明变量只读</p>
<pre><code>// .eslintrc.js
module.exports = {
  globals: {
    var1: true,
    var2: true,
  },
};
</code></pre><h3 id="配置匹配规则"><a href="#配置匹配规则" class="headerlink" title="配置匹配规则"></a>配置匹配规则</h3><p>在配置文件中可以设置一些规则。这些规则的等级有三种：</p>
<ul>
<li>“off” 或者 0：   关闭规则。</li>
<li>“warn” 或者 1：  打开规则，并且作为一个警告（不影响 exit code）。</li>
<li>“error” 或者 2： 打开规则，并且作为一个错误（exit code 将会是1）。</li>
</ul>
<p>配置文件支持灵活的多种方式</p>
<ul>
<li><p><code>.eslintrc.*</code> 配置文件中统一配置</p>
<pre><code>// .eslintrc.js
module.exports = {
  rules: {
    eqeqeq: &apos;off&apos;,
    curly: &apos;error&apos;,
  },
};
</code></pre></li>
<li><p>文件中的注释和跳过规则</p>
<pre><code>/* eslint-disable */
// 中间的代码，会被跳过检查所有的代码
/* eslint-enable */

/* eslint-disable no-alert, no-console */
// 中间的代码，会被跳过检查列举的而两个规则
/* eslint-enable no-alert, no-console */

// eslint-disable-next-line
console.log(&apos;test&apos;)
</code></pre></li>
</ul>
<h3 id="继承规则"><a href="#继承规则" class="headerlink" title="继承规则"></a>继承规则</h3><p>使用配置文件设置规则是，既可以选择只在<code>rules</code>中设置，还可以选择从他处继承。我们可以将定义好规则的<code>.eslintrc.js</code>文件存储到一个公共的位置，比如<code>public-eslintrc.js</code>：</p>
<pre><code>module.exports = {
  extends: &apos;eslint:recommended&apos;,
  env: {
    node: true,
  },
  rules: {
    &apos;no-console&apos;: &apos;off&apos;,
    &apos;indent&apos;: [ &apos;error&apos;, 2 ],
    &apos;quotes&apos;: [ &apos;error&apos;, &apos;single&apos; ],
  },
};
</code></pre><p>然后将原来的.eslintrc.js文件改成这样：</p>
<pre><code>module.exports = {
  extends: &apos;./public-eslintrc.js&apos;,
};
</code></pre><p>我们还可以使用已经发布到 NPM 上的 ESLint 配置，这些配置的模块名一般以<code>eslint-config-</code>为前缀，比如我在学习<code>ESLint</code>时自己编写的一个配置名为<code>eslint-config-xxx</code>。要使用这个配置，先执行以下命令安装它：</p>
<pre><code>npm install -g eslint-config-xxx
</code></pre><p>用于我们的eslint命令是全局安装的，所有用到的<code>eslint-config-*</code>模块也必须全局安装，否则将无法正确载入。这是一个已知的Bug，参考这里：<code>Error: Cannot read config package for shareable config using global eslint #4822</code></p>
<p>然后将.eslintrc.js文件改成这样：</p>
<pre><code>module.exports = {
  extends: &apos;xxx&apos;,
};
</code></pre><h2 id="四、执行"><a href="#四、执行" class="headerlink" title="四、执行"></a>四、执行</h2><h3 id="命令行执行"><a href="#命令行执行" class="headerlink" title="命令行执行"></a>命令行执行</h3><pre><code>eslint [options] file.js [file.js] [dir]
</code></pre><p>这条命令中ESLint会自动找到当前目录下的<code>.eslintrc.*</code>文件</p>
<blockquote>
<p>注意<code>eslint merge.js --fix</code>添加<code>--fix</code>结尾可以zi自动修复有<code>橙色扳手图标</code>的规则</p>
</blockquote>
<h3 id="配置到编译器"><a href="#配置到编译器" class="headerlink" title="配置到编译器"></a>配置到编译器</h3><p>本文已intelliJ IDEA为例 </p>
<p>   <img src="http://static.zybuluo.com/hellobeifeng1314/6rnplmx4basrerq9md8wqtco/eslint_idea.png" alt="eslint_idea.png-246.4kB"><br>   <img src="http://static.zybuluo.com/hellobeifeng1314/0x55j9e2yyz5phdpdir9riwl/eslint_idea2.png" alt="eslint_idea2.png-59.6kB"></p>
<h3 id="使用自动化任务"><a href="#使用自动化任务" class="headerlink" title="使用自动化任务"></a>使用自动化任务</h3><pre><code>gulp-eslint
</code></pre><h2 id="五、实践-amp-amp-gulp-eslint"><a href="#五、实践-amp-amp-gulp-eslint" class="headerlink" title="五、实践 &amp;&amp; gulp-eslint"></a>五、实践 &amp;&amp; gulp-eslint</h2><h3 id="安装与介绍"><a href="#安装与介绍" class="headerlink" title="安装与介绍"></a>安装与介绍</h3><p><a href="https://github.com/adametry/gulp-eslint" target="_blank" rel="noopener">gulp-eslint</a>，是继承了 ESLint 功能的 gulp 插件，使用起来很简单，类似于命令行操作，直接安装</p>
<pre><code>npm install gulp-eslint --save-dev
</code></pre><h3 id="静态检查自动化任务"><a href="#静态检查自动化任务" class="headerlink" title="静态检查自动化任务"></a>静态检查自动化任务</h3><p>有了上面的基础，下面我们实现一个基础的自动化检查代码的gulp任务</p>
<ul>
<li><p>1.安装依赖</p>
<pre><code>{
  &quot;name&quot;: &quot;eslint_learning&quot;,
  &quot;version&quot;: &quot;0.0.0&quot;,
  &quot;description&quot;: &quot;eslint_learning&quot;,
  &quot;private&quot;: false,
  &quot;dependencies&quot;: {
    &quot;eslint-plugin-html&quot;: &quot;^3.2.2&quot;,
    &quot;gulp&quot;: &quot;3.9.1&quot;,
    &quot;gulp-eslint&quot;: &quot;1.0.0&quot;
  }
}
</code></pre></li>
<li><p>2.编写 eslint 配置文件</p>
<pre><code>{
  &quot;ecmaFeatures&quot;: {
    &quot;modules&quot;: true
  },
  &quot;plugins&quot;: [
      &quot;html&quot;
  ],
  &quot;env&quot;: {
    &quot;es6&quot;: true,
    &quot;browser&quot;: true
  },
  &quot;rules&quot;: {
    &quot;no-console&quot;: 2,
  }
}
</code></pre></li>
<li><p>3.编写 gulpfile 配置文件，添加自动化任务</p>
<pre><code>var gulp = require(&apos;gulp&apos;),
        eslint = require(&apos;gulp-eslint&apos;);

    gulp.task(&apos;lint&apos;, function() {
        return gulp.src([&apos;js/**/*.js&apos;, &apos;index.html&apos;])
            //.pipe(eslint({configFle:&quot;./.eslintrc&quot;}))
            .pipe(eslint())
            .pipe(eslint.format())
    });

    gulp.task(&apos;default&apos;, [&apos;lint&apos;], function() {
        // This will only run if the lint task is successful...
});
</code></pre></li>
<li><p>4.测试内容：index.html 中的javascript</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;eslint demo&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div&gt;hello world&lt;/div&gt;    
    &lt;script src=&quot;js/index.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        var a = 1;
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></li>
<li><p>5.测试内容 js/index.js</p>
<pre><code>let a = 1;
//console.log(&apos;ddd&apos;)
</code></pre></li>
<li><p>6.运行任务，查看结果</p>
<pre><code>gulp lint
</code></pre></li>
</ul>
<h2 id="六、git-hooks"><a href="#六、git-hooks" class="headerlink" title="六、git hooks"></a>六、git hooks</h2><p>git 给我们提供了很多钩子函数，用于给不同的命令如，<code>git commit</code>指令提供类似回调函数，会在对应的指令的恰当时机执行。本文中模拟的是在代码编写完毕执行<code>git commit</code>命令之前的钩子<code>pre-commit</code></p>
<p><img src="http://static.zybuluo.com/hellobeifeng1314/73x93gs9v0p4fc483u9hucz9/githooks1.png" alt="githooks1.png-78kB"></p>
<h3 id="直接自定义-pre-commit"><a href="#直接自定义-pre-commit" class="headerlink" title="直接自定义 pre-commit"></a>直接自定义 pre-commit</h3><p>我们去掉文件末尾的<code>.sample</code>部分，使 git 能够识别。重写里面的内容</p>
<pre><code>#!/bin/sh
#执行gulp任务，并将结果输出到临时文件
gulp lint | tee check.log

#检查gulp的check任务是否执行失败
if grep &quot;warning&quot; check.log || grep &quot;error&quot; check.log
then
echo -e &quot;\033[31m Code check fail! Please try again! \033[0m&quot;
rm check.log
exit 1
else
echo -e &quot;\033[32m Code check success! \033[0m&quot;
rm check.log
fi
</code></pre><p>然后安装插件 eslint-plugin-html</p>
<pre><code>sudo npm install eslint-plugin-html --save-dev
</code></pre><p>接下来我们尝试一下带着问题提交，</p>
<pre><code>git commit -m
</code></pre><p>果然，git 按照我们代码中写的那样，首先提示我们有错误，然后打断了提交流程</p>
<p><img src="http://static.zybuluo.com/hellobeifeng1314/7rums1lknrmxeb4u6ce1d6w2/githooks2.png" alt="githooks2.png-136.5kB"></p>
<h3 id="使用-插件"><a href="#使用-插件" class="headerlink" title="使用 插件"></a>使用 插件</h3><p>第一步：然后安装插件 eslint-plugin-html</p>
<pre><code>sudo npm install eslint-plugin-html --save-dev
</code></pre><p>安装完这个插件，会默认修改前文提到过的<code>pre-commit.sample</code>为<code>pre-commit</code>。</p>
<p>第二步：修改 package.json,添加<code>pre-commit</code>字段，设置<code>git commit</code>操作之前的任务</p>
<pre><code>{
  &quot;name&quot;: &quot;eslint_learning&quot;,
  &quot;version&quot;: &quot;1.2.1&quot;,
  &quot;description&quot;: &quot;eslint_learning&quot;,
  &quot;private&quot;: false,
  &quot;scripts&quot;: {
    &quot;lints&quot;: &quot;num=`gulp lint | grep &apos;problem&apos;|wc -l`;if [ $num -gt 0 ]; then echo wrongEslint;exit 2; else exit 0;fi&quot;,
    &quot;precommit-msg&quot;: &quot;echo &apos;Pre-commit checks...&apos; &amp;&amp; exit 0&quot;
  },
  &quot;dependencies&quot;: {
    &quot;eslint-plugin-html&quot;: &quot;^3.2.2&quot;,
    &quot;gulp&quot;: &quot;3.9.1&quot;,
    &quot;gulp-eslint&quot;: &quot;1.0.0&quot;
  },
  &quot;pre-commit&quot;: [
    &quot;precommit-msg&quot;,
    &quot;lints&quot;
  ],
  &quot;devDependencies&quot;: {
    &quot;pre-commit&quot;: &quot;^1.2.2&quot;
  }
}
</code></pre><p>可见，我们设置了两个前置任务</p>
<p>第三部：命令保存退出。接下来我们尝试一下带着问题提交，</p>
<pre><code>git commit -m
</code></pre><p>命令行提示如下内容</p>
<pre><code>xxxdeMacBook-Pro:test1 xxx$ git commit -m &quot;ddd&quot;
Pre-commit checks...
wrongEslint
pre-commit:
pre-commit: We&apos;ve failed to pass the specified git pre-commit hooks as the `lints`
pre-commit: hook returned an exit code (1). If you&apos;re feeling adventurous you can
pre-commit: skip the git pre-commit hooks by adding the following flags to your commit:
pre-commit:
pre-commit:   git commit -n (or --no-verify)
pre-commit:
pre-commit: This is ill-advised since the commit is broken.
pre-commit:
</code></pre><h2 id="八、推荐文章"><a href="#八、推荐文章" class="headerlink" title="八、推荐文章"></a>八、推荐文章</h2><p><a href="http://eslint.cn/docs/user-guide/getting-started" target="_blank" rel="noopener">ESLint中文网</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/10/11/Untitled/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/11/Untitled/" itemprop="url">
                  ElastAlert日志监控预警
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T16:17:00+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><h3 id="短信报警优化"><a href="#短信报警优化" class="headerlink" title="短信报警优化"></a>短信报警优化</h3><p>新增post报警方式，可用于发送动态短信<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 报警方式</span><br><span class="line">alert:</span><br><span class="line">- &quot;post&quot;</span><br><span class="line"></span><br><span class="line">http_post_url: &quot;http://adminhome.jinhui365.cn/sendSmsForAppAlert&quot;</span><br><span class="line"></span><br><span class="line"># phoneList 手机号，逗号分割的字符串。例如：&quot;15235446827,15235446827&quot;</span><br><span class="line"># content 短信内容。$&#123;&#125;代表动态内容</span><br><span class="line">http_post_static_payload:</span><br><span class="line">  phoneList: &quot;15235446827&quot;</span><br><span class="line">  content: &quot;$&#123;@timestamp&#125;, IOS $&#123;l&#125; 级别日志报警。版本$&#123;v&#125;,手机型号$&#123;d&#125;,日志数$&#123;num_hits&#125;.&quot;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>动态内容为邮件内容，目前仅支持首层的key字段</p>
</blockquote>
<p>举个例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">邮件内容为：</span><br><span class="line">@timestamp: 2018-01-16T02:38:08.340Z</span><br><span class="line">@version: 1</span><br><span class="line">_id: AWD81Lv0TU1e05j5IHmu</span><br><span class="line">_index: ios-2018.01.16</span><br><span class="line">_type: logs</span><br><span class="line">arg: &#123;</span><br><span class="line">    &quot;appkey&quot;: &quot;jh28a4c4bc6734f58b&quot;, </span><br><span class="line">    &quot;branchNo&quot;: &quot;88&quot;, </span><br><span class="line">    &quot;client&quot;: &quot;iOS&quot;, </span><br><span class="line">    &quot;encrypt&quot;: 0, </span><br><span class="line">    &quot;fundAccount&quot;: &quot;881125524&quot;, </span><br><span class="line">    &quot;signcode&quot;: &quot;2FBDC7A4842E30B8F9ACD112261ECF28&quot;, </span><br><span class="line">    &quot;timestamp&quot;: &quot;1504442929685&quot;, </span><br><span class="line">    &quot;token&quot;: &quot;u4ftBaBm-xg=&quot;, </span><br><span class="line">    &quot;uid&quot;: &quot;1861574&quot;, </span><br><span class="line">    &quot;version&quot;: &quot;5.15.0&quot;</span><br><span class="line">&#125;</span><br><span class="line">c: iOS</span><br><span class="line">d: iPhone 6s Plus</span><br><span class="line">host: ubuntu</span><br><span class="line">i: B6C1AB45-C3CC-4C60-BD10-259778C6699B</span><br><span class="line">ip: 223.104.95.169 贵阳市 移动</span><br><span class="line">l: warn</span><br><span class="line">message: request failed:0 /receipt/list</span><br><span class="line">n: WiFi</span><br><span class="line">num_hits: 3182</span><br><span class="line">num_matches: 3</span><br><span class="line">o: 中国移动</span><br><span class="line">p: com.jinhui365.iphone-pay</span><br><span class="line">path: /data/node-dev-tools/logs/iOS.log</span><br><span class="line">s: 10.3.1</span><br><span class="line">t: 1504442928.55</span><br><span class="line">uid: 1861574</span><br><span class="line">v: 5.15.0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content：&quot;测试，测试，这个是个测试！message:$&#123;message&#125;,num_hits:$&#123;num_hits&#125;&quot;</span><br><span class="line">发送的短信为：测试，测试，这个是个测试！message:request failed:0 /receipt/list,num_hits:3182</span><br></pre></td></tr></table></figure>
<h3 id="jira日志报警记录"><a href="#jira日志报警记录" class="headerlink" title="jira日志报警记录"></a>jira日志报警记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 报警标题</span><br><span class="line">alert_subject: &quot;&#123;0&#125; &#123;1&#125; &#123;2&#125; &#123;3&#125;&quot;</span><br><span class="line">alert_subject_args:</span><br><span class="line">- &quot;c&quot;</span><br><span class="line">- &quot;v&quot;</span><br><span class="line">- &quot;l&quot;</span><br><span class="line">- &quot;@timestamp&quot;</span><br><span class="line"></span><br><span class="line"># 报警方式</span><br><span class="line">alert:</span><br><span class="line">- &quot;jira&quot;</span><br><span class="line"></span><br><span class="line"># 配置（规则文件中不写）</span><br><span class="line">jira_server: &quot;http://jira.jinhui365.cn&quot;</span><br><span class="line">jira_project: &quot;ALERT&quot;</span><br><span class="line">jira_account_file: &quot;/home/jhjr/jinhui/java/elaticalert/java_rules/jira_acct.txt&quot;</span><br><span class="line"></span><br><span class="line"># 目前只支持Task,受限于jira</span><br><span class="line">jira_issuetype: &quot;Task&quot;</span><br><span class="line"></span><br><span class="line"># jira issue优先级（默认普通级别。可选0-3，数字越小优先级越高）</span><br><span class="line">jira_priority: 0</span><br><span class="line"></span><br><span class="line"># 添加关注者(会有jira邮件发送到对应邮箱)</span><br><span class="line">jira_watchers: </span><br><span class="line">- xfwei</span><br><span class="line">- yli</span><br></pre></td></tr></table></figure>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><ul>
<li><a href="https://github.com/bitsensor/elastalert-kibana-plugin" target="_blank" rel="noopener">ElastAlert Kibana plugin</a></li>
<li><a href="https://github.com/bitsensor/elastalert" target="_blank" rel="noopener">Elastalert Server</a></li>
<li><a href="https://github.com/Yelp/elastalert/tree/v0.0.96" target="_blank" rel="noopener">Elastalert</a></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>根据<a href="https://github.com/bitsensor/elastalert#installing-kibana-plugin" target="_blank" rel="noopener">ElastAlert Server安装教程</a>进行kibana插件和ElastAlert Server安装.</li>
<li>根据<a href="http://elastalert.readthedocs.io/en/latest/running_elastalert.html" target="_blank" rel="noopener">ElastAlert官方网站</a>安装Elastalert.</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="Elastalert-Server"><a href="#Elastalert-Server" class="headerlink" title="Elastalert Server"></a>Elastalert Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;appName&quot;: &quot;elastalert-server&quot;,</span><br><span class="line">  &quot;port&quot;: 3030, //指定指定elastalert　server端口，为kibana插件提供服务</span><br><span class="line">  &quot;elastalertPath&quot;: &quot;/opt/elastalert/elastalert&quot;, //指定elastalert路径</span><br><span class="line">  &quot;verbose&quot;: true,</span><br><span class="line">  &quot;es_debug&quot;: true,</span><br><span class="line">  &quot;debug&quot;: false,</span><br><span class="line">  &quot;rulesPath&quot;: &#123;　//elastalert报警规则存储相对路径</span><br><span class="line">    &quot;relative&quot;: true,</span><br><span class="line">    &quot;path&quot;: &quot;/rules&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;templatesPath&quot;: &#123;　//规则模板相对路径</span><br><span class="line">    &quot;relative&quot;: true,</span><br><span class="line">    &quot;path&quot;: &quot;/rule_templates&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dataPath&quot;: &#123; //测试数据存储路径</span><br><span class="line">    &quot;relative&quot;: true, folder.</span><br><span class="line">    &quot;path&quot;: &quot;/server_data&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>详细配置见<a href="https://github.com/bitsensor/elastalert#config" target="_blank" rel="noopener">Elastalert Server 配置</a></p>
</blockquote>
<h3 id="ElastAlert"><a href="#ElastAlert" class="headerlink" title="ElastAlert"></a>ElastAlert</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">es_host: 10.0.0.219</span><br><span class="line">es_port: 9200</span><br><span class="line"></span><br><span class="line"># 规则文件夹</span><br><span class="line">rules_folder: rules</span><br><span class="line"></span><br><span class="line"># 查询频率</span><br><span class="line">run_every:</span><br><span class="line">  minutes: 1</span><br><span class="line"></span><br><span class="line"># 查询时间片（可覆盖）</span><br><span class="line">buffer_time:</span><br><span class="line">  minutes: 60</span><br><span class="line">  </span><br><span class="line"># 邮箱配置</span><br><span class="line">smtp_host: mail.rxhui.com</span><br><span class="line">smtp_port: 25</span><br><span class="line"></span><br><span class="line">smtp_auth_file: /opt/elastalert/config/smtp_auth_file.yaml</span><br><span class="line">email_reply_to: monitor@rxhui.com</span><br><span class="line">from_addr: monitor@rxhui.com</span><br><span class="line"></span><br><span class="line"># 写回kibana中的索引</span><br><span class="line">writeback_index: elastalert_status</span><br><span class="line"></span><br><span class="line"># 重发机制</span><br><span class="line">alert_time_limit:</span><br><span class="line">  days: 2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>详细配置见<a href="http://elastalert.readthedocs.io/en/latest/ruletypes.html" target="_blank" rel="noopener">Elastalert 配置</a></p>
</blockquote>
<h2 id="使用教程"><a href="#使用教程" class="headerlink" title="使用教程"></a>使用教程</h2><h3 id="打开方式"><a href="#打开方式" class="headerlink" title="打开方式"></a>打开方式</h3><ol>
<li>该功能嵌入至kibana中，打开kibana:<strong><a href="http://10.0.0.219:5601" target="_blank" rel="noopener">http://10.0.0.219:5601</a></strong>左上角setting右侧有个展开按钮，可供选择进入elastalert功能。</li>
<li>直接输入<strong><a href="http://10.0.0.219:5601/app/elastalert" target="_blank" rel="noopener">http://10.0.0.219:5601/app/elastalert</a></strong>进入。</li>
</ol>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p><img src="https://www.bitsensor.io/assets/img/screenshots/template.gif" alt="操作动态图"></p>
<ul>
<li>＋ New Rule可添加一条新的规则</li>
<li>点击规则可以删除和修改</li>
<li>规则页面右侧有一些模板可以点击展示</li>
<li>规则页面左上角退出，右上角分别为[测试],[保存]，测试完成后右侧会有输出</li>
</ul>
<p><strong>注意</strong></p>
<blockquote>
<p>１．添加新的规则需测试后才能保存，若直接保存可能因规则错误导致监听停止。<br>２．添加新的规则如果不想继续添加，记得将目录页该规则删除。<br>３．若因错误操作导致监听停止，可删除错误规则文件后访问<strong><a href="http://10.0.0.219:3030/status/control/start" target="_blank" rel="noopener">http://10.0.0.219:3030/status/control/start</a></strong>重新启动监听，通过<strong><a href="http://10.0.0.219:3030/status" target="_blank" rel="noopener">http://10.0.0.219:3030/status</a></strong>查看监听状态</p>
</blockquote>
<h2 id="ElastAlert-配置和规则说明"><a href="#ElastAlert-配置和规则说明" class="headerlink" title="ElastAlert 配置和规则说明"></a>ElastAlert 配置和规则说明</h2><h3 id="ElastAlert-配置"><a href="#ElastAlert-配置" class="headerlink" title="ElastAlert 配置"></a>ElastAlert 配置</h3><table>
<thead>
<tr>
<th>参数</th>
<th>　说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>es_host</td>
<td>　Elasticsearch的host地址</td>
<td></td>
</tr>
<tr>
<td>es_port</td>
<td>Elasticsearch的端口号</td>
<td>默认为9200</td>
</tr>
<tr>
<td>rules_folder</td>
<td>规则文件夹的名称</td>
<td></td>
</tr>
<tr>
<td>run_every</td>
<td>用来设置定时向elasticsearch发送请求</td>
</tr>
<tr>
<td>buffer_time</td>
<td>用来设置请求李时间字段的范围</td>
<td></td>
</tr>
<tr>
<td>realert</td>
<td>设定报警后的一段时间内忽略报警</td>
<td>默认为1分钟，可以设置为0</td>
</tr>
<tr>
<td>query_delay</td>
<td>减去查询所花的时间</td>
<td></td>
</tr>
<tr>
<td>writeback_index</td>
<td>elastalert产生的日志在elasticsearch中创建的索引</td>
<td></td>
</tr>
<tr>
<td>alert_time_limit</td>
<td>失败重试的时间设置</td>
</tr>
<tr>
<td>es_send_get_body_as</td>
<td>查询Elasticsearch的请求方式</td>
<td>默认为get</td>
</tr>
</tbody>
</table>
<h3 id="ElastAlert-规则"><a href="#ElastAlert-规则" class="headerlink" title="ElastAlert 规则"></a>ElastAlert 规则</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>规则名称</td>
<td>英文，不能包含中文</td>
</tr>
<tr>
<td>type</td>
<td>报警规则检查类型</td>
</tr>
<tr>
<td>alert</td>
<td>报警的方式</td>
</tr>
<tr>
<td>index</td>
<td>监视的索引</td>
</tr>
<tr>
<td>filter</td>
<td>检索的条件</td>
</tr>
<tr>
<td>realert</td>
<td>设置n时间内只警报一次</td>
</tr>
<tr>
<td>email</td>
<td>若报警有email方式，为收邮件的邮箱</td>
</tr>
<tr>
<td>aggregation</td>
<td>聚合日志，能够攒齐了一段时间的警告再上报。也可以用schedule定时间发送这一段时间的所有警告</td>
<td>可以考虑是否使用</td>
</tr>
<tr>
<td>import</td>
<td>可以引用公共部分</td>
<td>后续的规则多了之后考虑将公共部分抽出</td>
</tr>
</tbody>
</table>
<h4 id="报警类型"><a href="#报警类型" class="headerlink" title="报警类型"></a>报警类型</h4><ul>
<li>any：只要有匹配就报警；</li>
<li>blacklist：compare_key字段的内容匹配上 blacklist数组里任意内容；</li>
<li>whitelist：compare_key字段的内容一个都没能匹配上whitelist数组里内容；</li>
<li>frequency：在相同 query_key条件下，timeframe 范围内有num_events个被过滤出 来的异常；</li>
<li>change：在相同query_key条件下，compare_key字段的内容，在timeframe范围内 发生变化；</li>
<li>spike：在相同query_key条件下，前后两个timeframe范围内数据量相差比例超过spike_height。其中可以通过spike_type设置具体涨跌方向是up,down,both 。还可以通过threshold_ref设置要求上一个周期数据量的下限，threshold_cur设置要求当前周期数据量的下限，如果数据量不到下限，也不触发；</li>
<li>flatline：timeframe 范围内，数据量小于threshold 阈值；</li>
<li>new_term：fields字段新出现之前terms_window_size(默认30天)范围内最多的terms_size (默认50)个结果以外的数据；</li>
<li>cardinality：在相同 query_key条件下，timeframe范围内cardinality_field的值超过 max_cardinality 或者低于min_cardinality</li>
</ul>
<h4 id="报警方式"><a href="#报警方式" class="headerlink" title="报警方式"></a>报警方式</h4><ul>
<li>Command</li>
<li>email</li>
<li>jira</li>
<li>post</li>
</ul>
<blockquote>
<p>具体规则书写查看文章末尾规则模板</p>
</blockquote>
<h3 id="ElastAlert-1"><a href="#ElastAlert-1" class="headerlink" title="ElastAlert"></a>ElastAlert</h3><h4 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h4><ul>
<li><p>query_string<br>查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filter:</span><br><span class="line">- query_string:</span><br><span class="line">    query: &quot;username: bob&quot;</span><br></pre></td></tr></table></figure>
<p>query_string类型和Lucene的查询规则一致，具体细节可查看<a href="http://lucene.apache.org/core/2_9_4/queryparsersyntax.html" target="_blank" rel="noopener">Lucene Query</a><br>也可以通过将kibana上面的json格式转化为yaml的格式查询</p>
</li>
<li><p>term<br>精确匹配键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filter:</span><br><span class="line">- terms:</span><br><span class="line">    field: [&quot;value1&quot;, &quot;value2&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>terms<br>键值对匹配多个值</p>
</li>
<li><p>wildcard<br>标准的 shell 通配符</p>
</li>
<li><p>range<br>范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter:</span><br><span class="line">- range:</span><br><span class="line">    status_code:</span><br><span class="line">    from: 500</span><br><span class="line">    to: 599</span><br></pre></td></tr></table></figure>
</li>
<li><p>Negation, and, or<br>与或非</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filter:</span><br><span class="line">- or:</span><br><span class="line">    - term:</span><br><span class="line">        field: &quot;value&quot;</span><br><span class="line">    - wildcard:</span><br><span class="line">        field: &quot;foo*bar&quot;</span><br><span class="line">    - and:</span><br><span class="line">        - not:</span><br><span class="line">            term:</span><br><span class="line">              field: &quot;value&quot;</span><br><span class="line">        - not:</span><br><span class="line">            term:</span><br><span class="line">              _type: &quot;something&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>以上规则在文档<a href="http://elastalert.readthedocs.io/en/latest/recipes/writing_filters.html#common-filter-types" target="_blank" rel="noopener">ElastAlert Filters</a>中皆有详细描述</p>
<h2 id="规则模板"><a href="#规则模板" class="headerlink" title="规则模板"></a>规则模板</h2><h3 id="复杂的query-string查询"><a href="#复杂的query-string查询" class="headerlink" title="复杂的query_string查询"></a>复杂的query_string查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># 时间标准</span><br><span class="line"># seconds: 0~60</span><br><span class="line"># minutes: 0~60</span><br><span class="line"># hours: 0~60</span><br><span class="line"># days: n</span><br><span class="line">type: frequency</span><br><span class="line"></span><br><span class="line"># 规则名称</span><br><span class="line">name: android_log_test</span><br><span class="line"></span><br><span class="line"># 轮询频率，run_every建议小于timeframe</span><br><span class="line">run_every: </span><br><span class="line">  minutes: 1</span><br><span class="line"></span><br><span class="line"># 轮转日志块，buffer_time大于timeframe，且建议为timeframe的整数倍（2-3倍）</span><br><span class="line">buffer_time:</span><br><span class="line">  minutes: 15</span><br><span class="line"></span><br><span class="line"># 触发标准，再timeframe时间内发生num_events数量的事件，触发报警</span><br><span class="line"># 事件发生时间范围</span><br><span class="line">timeframe:</span><br><span class="line">  minutes: 5</span><br><span class="line"># 事件发生数量</span><br><span class="line">num_events: 2</span><br><span class="line"></span><br><span class="line"># 查询索引，参照kibana中的索引</span><br><span class="line">index: android-*</span><br><span class="line"></span><br><span class="line"># 检索条件</span><br><span class="line"># 更详细的查询：http://lucene.apache.org/core/2_9_4/queryparsersyntax.html</span><br><span class="line"># query: &quot;message: \&quot;load patch error\&quot; AND message: lo?d&quot;</span><br><span class="line"># message==&quot;load patch error&quot; &amp;&amp; message: &quot;lo?d&quot;</span><br><span class="line"></span><br><span class="line"># + - &amp;&amp; || ! ( ) &#123; &#125; [ ] ^ &quot; ~ * ? : \ </span><br><span class="line"># 以上字符需转义</span><br><span class="line"></span><br><span class="line"># 基本键值对查询</span><br><span class="line"># query: &quot;key: \&quot;value\&quot;&quot;</span><br><span class="line"># 反例：query: &quot;key: value1 value2 value3&quot; 这将查询key==value1 || 包含value2的log || 包含value3的log</span><br><span class="line"></span><br><span class="line"># 键值对模糊查询用通配符</span><br><span class="line"># query：&quot;key: v*e&quot;</span><br><span class="line"></span><br><span class="line"># 与或非</span><br><span class="line"># key1 AND key2</span><br><span class="line"># key1 OR key2</span><br><span class="line"># NOT key1</span><br><span class="line"></span><br><span class="line"># 分组查询： （）代表分组</span><br><span class="line"># query: &quot;title:(return AND \&quot;pink panther\&quot;)&quot; title==&quot;return&quot; &amp;&amp; title=&quot;pink panther&quot; （return可以用通配符，被引号引住的pink panther不能用通配）</span><br><span class="line"># (key1 OR key2) AND key3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filter:</span><br><span class="line">- query:</span><br><span class="line">    query_string:</span><br><span class="line">      query: &quot;message: \&quot;load patch error\&quot; AND message: lo?d&quot;</span><br><span class="line"></span><br><span class="line"># 规定n个时间内不会多次收到相同日志，frequency方式下该字段建议定义为timeframe的整数倍</span><br><span class="line">realert:</span><br><span class="line">  minutes: 5</span><br><span class="line"></span><br><span class="line"># 报警方式</span><br><span class="line">alert:</span><br><span class="line">- &quot;email&quot;</span><br><span class="line"># - &quot;command&quot;</span><br><span class="line"></span><br><span class="line"># phoneList为,分割的手机号字符串，content为接收手机内容</span><br><span class="line"># command: [&quot;curl&quot;, &quot;-X&quot;, &quot;POST&quot;, &quot;--header&quot;, &quot;Content-Type: application/json&quot;, &quot;--header&quot;, &quot;Accept: */*&quot;, &quot;http://adminhome.jinhui365.cn:8009/sendSms?phoneList=15235446827&amp;content=测试&quot;]</span><br><span class="line"></span><br><span class="line">email:</span><br><span class="line">- &quot;yli@rxhui.com&quot;</span><br><span class="line"># - &quot;15235446827@139.com&quot;</span><br></pre></td></tr></table></figure>
<h3 id="与或非查询"><a href="#与或非查询" class="headerlink" title="与或非查询"></a>与或非查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"># 时间标准</span><br><span class="line"># seconds: 0~60</span><br><span class="line"># minutes: 0~60</span><br><span class="line"># hours: 0~60</span><br><span class="line"># days: n</span><br><span class="line">type: frequency</span><br><span class="line"></span><br><span class="line"># 规则名称</span><br><span class="line">name: android_log_test</span><br><span class="line"></span><br><span class="line"># 轮询频率，run_every建议小于timeframe</span><br><span class="line">run_every: </span><br><span class="line">  minutes: 1</span><br><span class="line"></span><br><span class="line"># 轮转日志块，buffer_time大于timeframe，且建议为timeframe的整数倍（2-3倍）</span><br><span class="line">buffer_time:</span><br><span class="line">  minutes: 15</span><br><span class="line"></span><br><span class="line"># 触发标准，再timeframe时间内发生num_events数量的事件，触发报警</span><br><span class="line"># 事件发生时间范围</span><br><span class="line">timeframe:</span><br><span class="line">  minutes: 5</span><br><span class="line"># 事件发生数量</span><br><span class="line">num_events: 2</span><br><span class="line"></span><br><span class="line"># 查询索引，参照kibana中的索引</span><br><span class="line">index: android-*</span><br><span class="line"></span><br><span class="line"># 检索条件</span><br><span class="line"># 翻译kibana查询语句，特殊字符@要用“”包起来</span><br><span class="line"># message==&quot;text data message&quot; &amp;&amp; @version==&quot;1&quot; &amp;&amp; (uid==&quot;1111&quot; || !v==&quot;5.22.0&quot;)</span><br><span class="line"></span><br><span class="line">filter:</span><br><span class="line">- and:</span><br><span class="line">  - query:</span><br><span class="line">      match:</span><br><span class="line">        message:  </span><br><span class="line">          query: &quot;text data message&quot;</span><br><span class="line">          type: &quot;phrase&quot;</span><br><span class="line">  - query:</span><br><span class="line">      match:</span><br><span class="line">        &quot;@version&quot;:</span><br><span class="line">          query: &quot;1&quot;</span><br><span class="line">          type: &quot;phrase&quot;</span><br><span class="line">  - or:</span><br><span class="line">    - query:</span><br><span class="line">        match:</span><br><span class="line">          uid:</span><br><span class="line">            query: &quot;1111&quot;</span><br><span class="line">            type: &quot;phrase&quot;</span><br><span class="line">    - not:</span><br><span class="line">      - query:</span><br><span class="line">          match:</span><br><span class="line">            v:</span><br><span class="line">              query: &quot;5.22.0&quot;</span><br><span class="line">              type: &quot;phrase&quot;</span><br><span class="line"></span><br><span class="line"># 规定n个时间内不会多次收到相同日志，frequency方式下该字段建议定义为timeframe的整数倍</span><br><span class="line">realert:</span><br><span class="line">  minutes: 5</span><br><span class="line"></span><br><span class="line"># 报警方式</span><br><span class="line">alert:</span><br><span class="line">- &quot;email&quot;</span><br><span class="line"># - &quot;command&quot;</span><br><span class="line"></span><br><span class="line"># phoneList为,分割的手机号字符串，content为接收手机内容</span><br><span class="line"># command: [&quot;curl&quot;, &quot;-X&quot;, &quot;POST&quot;, &quot;--header&quot;, &quot;Content-Type: application/json&quot;, &quot;--header&quot;, &quot;Accept: */*&quot;, &quot;http://adminhome.jinhui365.cn:8009/sendSms?phoneList=15235446827&amp;content=测试&quot;]</span><br><span class="line"></span><br><span class="line">email:</span><br><span class="line">- &quot;yli@rxhui.com&quot;</span><br><span class="line"># - &quot;15235446827@139.com&quot;</span><br></pre></td></tr></table></figure>
<h2 id="ElastAlert-Server-API"><a href="#ElastAlert-Server-API" class="headerlink" title="ElastAlert Server API"></a>ElastAlert Server API</h2><p>This server exposes the following REST API’s:</p>
<ul>
<li><p><strong>GET <code>/</code></strong></p>
<p>  Exposes the current version running</p>
</li>
<li><p><strong>GET <code>/status</code></strong></p>
<p>  Returns either ‘SETUP’, ‘READY’, ‘ERROR’, ‘STARTING’, ‘CLOSING’, ‘FIRST_RUN’ or ‘IDLE’ depending on the current ElastAlert process status. </p>
</li>
<li><p><strong>GET <code>/status/control/:action</code></strong></p>
<p>  Where <code>:action</code> can be either ‘start’ or ‘stop’, which will respectively start or stop the current ElastAlert process.</p>
</li>
<li><p><strong>[WIP] GET <code>/status/errors</code></strong></p>
<p>  When <code>/status</code> returns ‘ERROR’ this returns a list of errors that were triggered.</p>
</li>
<li><p><strong>GET <code>/rules</code></strong></p>
<p>  Returns a list of directories and rules that exist in the <code>rulesPath</code> (from the config) and are being run by the ElastAlert process.</p>
</li>
<li><p><strong>GET <code>/rules/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the rule returned by <strong>GET <code>/rules</code></strong>, which will return the file contents of that rule.</p>
</li>
<li><p><strong>POST <code>/rules/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the rule returned by <strong>GET <code>/rules</code></strong>, which will allow you to edit the rule. The body send should be:</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Required - The full yaml rule config.</span></span><br><span class="line">  <span class="string">"yaml"</span>: <span class="string">"..."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<ul>
<li><p><strong>DELETE <code>/rules/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the rule returned by <strong>GET <code>/rules</code></strong>, which will delete the given rule.</p>
</li>
<li><p><strong>GET <code>/templates</code></strong></p>
<p>  Returns a list of directories and templates that exist in the <code>templatesPath</code> (from the config) and are being run by the ElastAlert process.</p>
</li>
<li><p><strong>GET <code>/templates/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the template returned by <strong>GET <code>/templates</code></strong>, which will return the file contents of that template.</p>
</li>
<li><p><strong>POST <code>/templates/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the template returned by <strong>GET <code>/templates</code></strong>, which will allow you to edit the template. The body send should be:</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Required - The full yaml template config.</span></span><br><span class="line">  <span class="string">"yaml"</span>: <span class="string">"..."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<ul>
<li><p><strong>DELETE <code>/templates/:id</code></strong></p>
<p>  Where <code>:id</code> is the id of the template returned by <strong>GET <code>/templates</code></strong>, which will delete the given template.</p>
</li>
<li><p><strong>POST <code>/test</code></strong></p>
<p>  This allows you to test a rule. The body send should be:</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Required - The full yaml rule config.</span></span><br><span class="line">        <span class="string">"rule"</span>: <span class="string">"..."</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Optional - The options to use for testing the rule.</span></span><br><span class="line">        <span class="string">"options"</span>: &#123;</span><br><span class="line">        </span><br><span class="line">          <span class="comment">// Can be either "all", "schemaOnly" or "countOnly". "all" will give the full console output. </span></span><br><span class="line">          <span class="comment">// "schemaOnly" will only validate the yaml config. "countOnly" will only find the number of matching documents and list available fields.</span></span><br><span class="line">          <span class="string">"testType"</span>: <span class="string">"all"</span>,</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// Can be any number larger than 0 and this tells ElastAlert over a period of how many days the test should be run</span></span><br><span class="line">          <span class="string">"days"</span>: <span class="string">"1"</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// Whether to send real alerts</span></span><br><span class="line">          <span class="string">"alert"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">- **[WIP] GET `</span>/config<span class="string">`**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Gets the ElastAlert configuration from `</span>config.yaml<span class="string">` in `</span>elastalertPath<span class="string">` (from the config).</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">- **[WIP] POST `</span>/config<span class="string">`**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Allows you to edit the ElastAlert configuration from `</span>config.yaml<span class="string">` in `</span>elastalertPath<span class="string">` (from the config). The required body to be send will be edited when the work on this API is done.</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">## ElastAlert监控规律</span></span><br><span class="line"><span class="string">ElastAlert根据config中的run_every设置的时间频率去轮询，每次查询的时间块都是buffer_time</span></span><br></pre></td></tr></table></figure>
</code></pre><p>  基本查询规律：<br>  配置: run_every:20s, buffer_time:1min</p>
<p>  当前时间1月17日9时启动监控<br>  当前时间   日志时间块<br>  9:00:00   8:59:00~9:00:00<br>  9:00:20   9:00:00~9:00:20<br>  9:00:40   9:00:00~9:00:40<br>  9:01:00   9:00:00~9:01:00<br>  9:01:20   9:01:00~9:01:20<br>  9:01:40   9:01:00~9:01:40<br>  9:02:00   9:01:00~9:02:00<br><code>`</code></p>
<p><strong>传送门</strong></p>
</li>
<li><a href="https://bitsensor.io/index.php" target="_blank" rel="noopener">Bitsensor博客网站</a></li>
<li><a href="https://github.com/bitsensor/elastalert-kibana-plugin" target="_blank" rel="noopener">ElastAlert Kibana Plugin</a></li>
<li><a href="https://github.com/bitsensor/elastalert" target="_blank" rel="noopener">Elastalert Server</a></li>
<li><a href="https://github.com/Yelp/elastalert" target="_blank" rel="noopener">Elastalert Github</a></li>
<li><a href="http://elastalert.readthedocs.io/en/latest/running_elastalert.html" target="_blank" rel="noopener">ElastAlert官方网站</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/10/11/ECMAScript-2015-语法分享/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/11/ECMAScript-2015-语法分享/" itemprop="url">
                  ECMAScript 2015 语法分享
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T15:53:09+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一部分：前言"><a href="#第一部分：前言" class="headerlink" title="第一部分：前言"></a>第一部分：前言</h1><h2 id="一、为什么要使用-ES6"><a href="#一、为什么要使用-ES6" class="headerlink" title="一、为什么要使用 ES6"></a>一、为什么要使用 ES6</h2><p>ES6代表了未来，对未来理应拥抱。为从以下几个角度来看，ES6的推广势在必行：</p>
<ul>
<li><p>解放开发效率</p>
<ul>
<li>新特性的合理使用，优雅而简洁</li>
<li>减少第三方库的依赖</li>
<li>可维护性提升，代码量减少</li>
</ul>
</li>
<li><p>面向未来。</p>
<ul>
<li>向标准靠拢</li>
<li>官方支持</li>
<li>迟早要学</li>
</ul>
</li>
<li><p>其他方面</p>
<ul>
<li>提升技术先进性</li>
<li>促进技术交流，提高技术氛围</li>
<li>编程激情</li>
<li>整合部分历史代码的好机会</li>
</ul>
</li>
</ul>
<h2 id="二、Nodejs各版本对应的ES6支持情况"><a href="#二、Nodejs各版本对应的ES6支持情况" class="headerlink" title="二、Nodejs各版本对应的ES6支持情况"></a>二、Nodejs各版本对应的ES6支持情况</h2><p>1、如果你想一览Node不同版本对所有ES6的特性支持情况，就可以参看<a href="http://node.green/" target="_blank" rel="noopener">node.green</a>这个网站</p>
<p>可以看到<br>6.11.2 - 99%<br>6.4.0 - 95%<br>5.12.0 - 59%</p>
<p>2、可以安转<code>es-checker</code>工具，通过该工具查看node支持的es6语法</p>
<pre><code>sudo npm install es-checker -g
</code></pre><h2 id="三、实用特性使用情况"><a href="#三、实用特性使用情况" class="headerlink" title="三、实用特性使用情况"></a>三、实用特性使用情况</h2><p><img src="https://yqfile.alicdn.com/f1ae6e19b5580b4f3a618e5351b74c55fd4beefb.jpeg" alt=""></p>
<table>
<thead>
<tr>
<th style="text-align:center">特性</th>
<th style="text-align:center">推荐程度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">arrows</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">enhanced object literals</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">template strings</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">destructuring</td>
<td style="text-align:center">★★</td>
</tr>
<tr>
<td style="text-align:center">default + rest + spread</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">promises</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">math + number + string + array + object APIs</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">let + const</td>
<td style="text-align:center">★★★</td>
</tr>
<tr>
<td style="text-align:center">iterators + for..of</td>
<td style="text-align:center">★★</td>
</tr>
<tr>
<td style="text-align:center">tail calls</td>
<td style="text-align:center">★★</td>
</tr>
<tr>
<td style="text-align:center">modules</td>
<td style="text-align:center">★★</td>
</tr>
<tr>
<td style="text-align:center">map + set + weakmap + weakset</td>
<td style="text-align:center">★★</td>
</tr>
<tr>
<td style="text-align:center">generators</td>
<td style="text-align:center">★</td>
</tr>
<tr>
<td style="text-align:center">classes</td>
<td style="text-align:center">★</td>
</tr>
<tr>
<td style="text-align:center">binary and octal literals</td>
<td style="text-align:center">★</td>
</tr>
<tr>
<td style="text-align:center">symbols</td>
<td style="text-align:center">★</td>
</tr>
<tr>
<td style="text-align:center">module loaders</td>
<td style="text-align:center">☆</td>
</tr>
<tr>
<td style="text-align:center">proxies</td>
<td style="text-align:center">☆</td>
</tr>
<tr>
<td style="text-align:center">subclassable built-ins</td>
<td style="text-align:center">☆</td>
</tr>
<tr>
<td style="text-align:center">reflect api</td>
<td style="text-align:center">☆</td>
</tr>
<tr>
<td style="text-align:center">unicode</td>
<td style="text-align:center">☆</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="第二部分-ES6-的实用特性"><a href="#第二部分-ES6-的实用特性" class="headerlink" title="第二部分 ES6 的实用特性"></a>第二部分 ES6 的实用特性</h1><h2 id="一、使用-let-和-const"><a href="#一、使用-let-和-const" class="headerlink" title="一、使用 let 和 const"></a>一、使用 let 和 const</h2><p>let: 用来声明变量。它的用法类似于<code>var</code>，但是所声明的变量，只在<code>let</code>命令所在的代码块内有效</p>
<p>const: 声明一个只读的常量。一旦声明，变量指向的那个内存地址不得改动。而且，<code>const</code>一旦声明变量，该变量就必须立即初始化，不能留到以后赋值。同样，声明的变量，只在<code>const</code>命令所在的代码块内有效。一般用<code>const</code>声明常亮。</p>
<h3 id="特点1：拥有块级作用域"><a href="#特点1：拥有块级作用域" class="headerlink" title="特点1：拥有块级作用域"></a>特点1：拥有块级作用域</h3><p><code>let</code>、<code>const</code>是一种新的变量申明方式，它允许你把变量作用域控制在块级里面。但是在ES5中，块级作用域起不了任何作用。下面列举两种常见的错误场景，然后你会发现会用ES6是这么轻松的就避免犯错！</p>
<ul>
<li><p>第一种常见场景：内层变量可能会覆盖外层变量</p>
<pre><code>var a = 2
{
       var a = 1;
}
a // 1，一不小心发生了同名变量的覆盖

let a = 2
{
       let a = 1;
}
a // 2 ，es6通过块级作用域避免了覆盖的发生
</code></pre></li>
<li><p>第二种常见场景：用来计数的循环变量泄露为全局变量</p>
<pre><code>for(var i = 0; i &lt; 3; i++ ) {}
console.log(i);//3，可见，此处的 i 已然成为了全局变量

for(let i=0;i&lt;3;i++) {}
console.log(i);//使用ES6 抛出异常 ReferenceError: i is not defined
</code></pre></li>
</ul>
<h3 id="特点2：没有变量提升"><a href="#特点2：没有变量提升" class="headerlink" title="特点2：没有变量提升"></a>特点2：没有变量提升</h3><p>ES6明确规定，如果区块中存在<code>let</code>和<code>const</code>命令，这个区块对这些命令声明的变量，从一开始就形成了封闭作用域。凡是在声明之前就使用这些变量，就会报错。首先看一个看变量在同一个块作用域内的情况</p>
<pre><code>// 发生了变量提升
if(true) {
  console.log(x); // undefined
  var x = &apos;hello&apos;;
}

// 不准许在变量声明之前使用
if(true) {
  console.log(x); // ReferenceError
  let x = &apos;hello&apos;;
}
</code></pre><p>这个特性杜绝了我们日常编码中随处声明变量的恶习，强制要求我们养成提前声明变量的习惯。变量的声明和使用在同一作用域下如此，在不同作用域下更是如此：</p>
<pre><code>{{{{
      {
      	console.log(insane); // 报错，提前使用了变量
      }
      let insane = 'Hello World'
    }}}};

{{{{
    	let insane = 'Hello World'
      {
      	console.log(insane); // hello world
      }
    }}}};
</code></pre><h3 id="特点3：不允许在相同作用域内，重复声明同一个变量"><a href="#特点3：不允许在相同作用域内，重复声明同一个变量" class="headerlink" title="特点3：不允许在相同作用域内，重复声明同一个变量"></a>特点3：不允许在相同作用域内，重复声明同一个变量</h3><pre><code>// 正常
function () {
  var a = 10;
  var a = 1;
  // a ,1
}
// 报错
function () {
  let a = 10;
  var a = 1;
}

// 报错
function () {
  let a = 10;
  let a = 1;
}

function func(arg) {
  let arg; // 报错
}

function func(arg) {
  {
    let arg; // 不报错
  }
}
</code></pre><h2 id="二、解构赋值"><a href="#二、解构赋值" class="headerlink" title="二、解构赋值"></a>二、解构赋值</h2><p>ES6 允许按照一定模式，从数组、对象中提取值，对变量进行赋值，这被称为解构。如果等号的右边不是可遍历的结构，如 {}, undefined, 数字常量值等，那么将会报错。下面列举三种最常见的结构场景</p>
<h3 id="1-对象的解构赋值"><a href="#1-对象的解构赋值" class="headerlink" title="1. 对象的解构赋值"></a>1. 对象的解构赋值</h3><p>如果变量名与属性名(key)一致，则会对应的赋值，不论位置顺序</p>
<pre><code>let { bar, foo } = { foo: &quot;aaa&quot;, bar: &quot;bbb&quot; };
foo // &quot;aaa&quot;
bar // &quot;bbb&quot;

let { foo, bar } = { foo: &quot;aaa&quot;, bar: &quot;bbb&quot; };
foo // &quot;aaa&quot;
bar // &quot;bbb&quot;，即使顺序变了，还是赋值给了对应的key
</code></pre><p>如果变量名与属性名不一致，必须写成下面这样</p>
<pre><code>// 希望将对象中的foo属性赋值给变量baz
var { foo: baz } = { foo: &apos;aaa&apos;, bar: &apos;bbb&apos; };
baz // &quot;aaa&quot;
</code></pre><p>结构失败，则变量赋值为<code>undefined</code>  </p>
<pre><code>let { baz } = { foo: &quot;aaa&quot;, bar: &quot;bbb&quot; };
baz // undefined
</code></pre><p>究其原理，其实对象的解构赋值是下面形式的简写：</p>
<pre><code>let { foo: foo, bar: bar } = { foo: &quot;aaa&quot;, bar: &quot;bbb&quot; };  
</code></pre><p>也就是说，对象的解构赋值的内部机制，是先找到同名属性，然后再赋给对应的变量。真正被赋值的是后者，而不是前者</p>
<pre><code>let { foo: baz } = { foo: &quot;aaa&quot;, bar: &quot;bbb&quot; };
baz // &quot;aaa&quot;
foo // error: foo is not defined
</code></pre><p>上面代码中，<code>foo</code>是匹配的模式，<code>baz</code>才是变量。真正被赋值的是变量<code>baz</code>，而不是模式<code>foo</code>。本段开始提到的<code>{foo}</code>其实是<code>{foo:foo}</code>的简写</p>
<p>在对象中使用解构赋值的好处很多，比如下文中，我们通过传递某个配置对象类完成某些赋值目的</p>
<pre><code>function init(options) {
      var id = options.uid;
      var cid = options.cid;
      var timeout = options.timeout;
      var protocol = options.protocol

      // code to init
}

var options = {
      id: &apos;101&apos;,
      cid: &apos;xxx&apos;,
      timeout: &apos;60&apos;,
      protocol: &apos;http&apos;
}

init(options)
</code></pre><p>这种方式实现起来很好，已经被许多JS开发者所采用。 只是我们必须看函数内部，才知道函数预期需要哪些参数。结合解构赋值，我们就可以在函数声明中清晰地表示这些参数：    </p>
<pre><code>function init(param, {id, cid, timeout, protocal}) {
    // code to init
}

var options = {
    id: &apos;101&apos;,
    cid: &apos;xxx&apos;,
    timeout: &apos;60&apos;,
    protocol: &apos;http&apos;
}

init(param, options)
</code></pre><p>在该函数中，我们没有传入一个配置对象，而是以对象解构赋值的方式，给它传参数。这样做不仅使这个函数更加简明，可读性也更高。</p>
<blockquote>
<p>注意如果函数调用时，参数被省略掉且没有设置默认值，则会抛出错误  </p>
</blockquote>
<p>函数解构和默认值组合使用的一个难点:再请问下面两种写法有什么差别？</p>
<pre><code>// 写法一
function m1({x = 0, y = 0} = {}) {
  return [x, y];
}

// 写法二
function m2({x, y} = { x: 0, y: 0 }) {
  return [x, y];
}
</code></pre><p>上面两种写法都对函数的参数设定了默认值，区别是：<br>写法一函数参数的默认值是空对象，但是设置了对象解构赋值的默认值；<br>写法二函数参数的默认值是一个有具体属性的对象，但是没有设置对象解构赋值的默认值。</p>
<pre><code>// 函数没有参数的情况
m1() // [0, 0]
m2() // [0, 0]

// x和y都有值的情况
m1({x: 3, y: 8}) // [3, 8]
m2({x: 3, y: 8}) // [3, 8]

// x有值，y无值的情况
m1({x: 3}) // [3, 0]
m2({x: 3}) // [3, undefined]

// x和y都无值的情况
m1({}) // [0, 0];
m2({}) // [undefined, undefined]

m1({z: 3}) // [0, 0]
m2({z: 3}) // [undefined, undefined]
</code></pre><p>本质上来说，如果实参有值的话，参数的默认值就不会生效。如果参数的默认值不生效，那么解构就无法发生。</p>
<h3 id="2-数组的解构赋值"><a href="#2-数组的解构赋值" class="headerlink" title="2. 数组的解构赋值"></a>2. 数组的解构赋值</h3><pre><code>const arr = [1, 2, 3, 4];

// bad
const first = arr[0];
const second = arr[1];

// good
const [first, second] = arr;
</code></pre><blockquote>
<p>数组的元素是按次序排列的，变量的取值由它的位置决定；而对象的属性没有次序，变量必须与属性同名，才能取到正确的值<br>和对象解构一样，如果解构不成功，变量的值就等于<code>undefined</code></p>
</blockquote>
<h3 id="3-函数返回值的解构"><a href="#3-函数返回值的解构" class="headerlink" title="3. 函数返回值的解构"></a>3. 函数返回值的解构</h3><p>函数只能返回一个值，如果要返回多个值，只能将它们放在数组或对象里返回。有了解构赋值，取出这些值就非常方便。</p>
<pre><code>function getVal() {
  return [ 1, 2 ];
}

let [x,y] = getVal();//函数返回值的解构
console.log(x ,y);// 1, 2
</code></pre><p>本质上，这种写法属于“模式匹配”，只要等号两边的模式相同或部分相同，左边的（部分）变量就会被赋予对应的值。下面是一些使用嵌套数组进行解构的例子。</p>
<pre><code>// 嵌套
let [foo, [[bar], baz]] = [1, [[2], 3]];
foo // 1
bar // 2
baz // 3

// ... 运算
let [head, ...tail] = [1, 2, 3, 4];
head // 1
tail // [2, 3, 4]

let [head, ...tail, tailest] = [1, 2, 3, 4];
// SyntaxError: Rest element must be last element in array
</code></pre><h3 id="4-解构赋值使用默认值"><a href="#4-解构赋值使用默认值" class="headerlink" title="4. 解构赋值使用默认值"></a>4. 解构赋值使用默认值</h3><p>解构赋值允许指定默认值。ES6 内部使用严格相等运算符<code>===</code>，判断一个位置是否有值。所以，如果一个数组成员不严格等于<code>undefined</code>，默认值是不会生效的</p>
<pre><code>let [foo = true] = [];
foo // true

let [x, y = &apos;b&apos;] = [&apos;a&apos;]; // x=&apos;a&apos;, y=&apos;b&apos;
let [x, y = &apos;b&apos;] = [&apos;a&apos;, undefined]; // x=&apos;a&apos;, y=&apos;b&apos;
let [x, y = &apos;b&apos;] = [&apos;a&apos;, &apos;undefined&apos;]; // x=&apos;a&apos;, y=&apos;undefined&apos;
let [x, y = &apos;b&apos;] = [&apos;a&apos;, null]; // x=&apos;a&apos;, y=null

var {x, y = 5} = {x: 1};
x // 1
y // 5
</code></pre><p>默认值可以引用解构赋值的其他变量，但该变量必须已经声明。</p>
<pre><code>let [x = 1, y = x] = [];     // x=1; y=1
let [x = 1, y = x] = [2];    // x=2; y=2
let [x = 1, y = x] = [1, 2]; // x=1; y=2
let [x = y, y = 1] = [];     // ReferenceError
</code></pre><h2 id="三、字符串扩展"><a href="#三、字符串扩展" class="headerlink" title="三、字符串扩展"></a>三、字符串扩展</h2><h3 id="1-模板文本"><a href="#1-模板文本" class="headerlink" title="1. 模板文本"></a>1. 模板文本</h3><p>模板字符串（template string）是增强版的字符串，用反引号（<code>）标识。它可以当作普通字符串使用，也可以用来定义多行字符串。在字符串中嵌入变量，需要将变量名写在</code>${}`之中。</p>
<p>首先，让我们看看 ES5 中拼接字符串的方式</p>
<pre><code>var name = &apos;feng&apos; , age = &apos;25&apos;;
var result = &apos;hello: &apos; + name + &apos;, your name is &apos; + age;
// hello: feng, your name is 25
</code></pre><p>再看看 ES6 的实现方式</p>
<pre><code>var name = &apos;feng&apos; , age = &apos;25&apos;;
var result = `hello: ${name}, your name is ${age}`
// hello: feng, your name is 25
</code></pre><p>模板中使用对象   </p>
<pre><code>let obj = {x:1,y:2};
console.log(`Your total is: ${obj.x + obj.y}`); // Your total is 3
</code></pre><p>模板中使用函数调用</p>
<pre><code>function fn() {
    return &quot;Hello World&quot;;
}

`foo ${fn()} bar`
// foo Hello World bar
</code></pre><p>这样做省略了很多影响阅读的<code>+ ,</code>，直接在反引号中使用变量书写，很美观和便利！</p>
<h3 id="2-多行字符串"><a href="#2-多行字符串" class="headerlink" title="2. 多行字符串"></a>2. 多行字符串</h3><p>ES6 的多行字符串是一个非常实用的功能。在 ES5 中，我们不得不使用以下方法来表示多行字符串</p>
<pre><code>var multStr = &apos;Then took the other, as just as fair,\n\t&apos;
    + &apos;And having perhaps the better claim\n\t&apos;
    + &apos;Because it was grassy and wanted wear,\n\t&apos;
    + &apos;Though as for that the passing there\n\t&apos;
    + &apos;Had worn them really about the same,\n\t&apos;;
</code></pre><p>然而在 ES6 中，仅仅用反引号就可以解决了：</p>
<pre><code>var multStr = `Then took the other, as just as fair,
    And having perhaps the better claim
    Because it was grassy and wanted wear,
    Though as for that the passing there
    Had worn them really about the same,`;
</code></pre><p>如果使用模板字符串表示多行字符串，所有的空格和缩进都会被保留在输出之中</p>
<pre><code>let tt = `
&lt;ul&gt;
    &lt;li&gt;first&lt;/li&gt;
    &lt;li&gt;second&lt;/li&gt;
&lt;/ul&gt;
`;
console.log(tt)
</code></pre><p>输出成如下内容</p>
<pre><code>&lt;ul&gt;
    &lt;li&gt;first&lt;/li&gt;
    &lt;li&gt;second&lt;/li&gt;
&lt;/ul&gt;
</code></pre><h2 id="四、函数扩展"><a href="#四、函数扩展" class="headerlink" title="四、函数扩展"></a>四、函数扩展</h2><h3 id="1-默认参数"><a href="#1-默认参数" class="headerlink" title="1. 默认参数"></a>1. 默认参数</h3><p>ES6 之前，不能直接为函数的参数指定默认值，只能采用变通的方法。项目中通过<code>||</code>来实现默认参数</p>
<pre><code>var link = function (height, color) {
    var height = height || 50;
    var color = color || &apos;red&apos;;
    console.log(height + &apos; : &apos; + color)
}

link();//50 red
link(10, &apos;blue&apos;);// 10 blue 1
</code></pre><p>目前来说是正常的，调用该函数时，没有传入实参，会用默认值。但是如果我们传入的参数本身会通过类型转换为<code>false</code>(比如<code>0</code> 或者<code>null</code>)就会有问题：系统忽略掉了我们的入参，反而使用了默认值！ </p>
<pre><code>link(0, &apos;blue&apos;);//50 blue
</code></pre><p>代码默认值是<code>50</code>，调用时希望设置为<code>0</code>，但是还是输出了默认值<code>50</code>。</p>
<p>在 ES6 中，我们通过如下方式来完成默认参数的设置，即直接写在参数定义的后面。我们甚至可以让默认值是一个函数（惰性求值）</p>
<pre><code>var link = function (height = 50, color = &apos;red&apos;) {
    console.log(height + &apos; : &apos; + color)
}

link(10, &apos;blue&apos;);//10: blue
link(0， blue);//0 blue
link();// 50 : red
</code></pre><p>还有一点需要着重介绍一下：默认参数可以和解构赋值默认值结合使用</p>
<pre><code>function foo({x, y = 5}) {
  console.log(x, y);
}

foo({}) // undefined, 5
foo({x: 1}) // 1, 5
foo({x: 1, y: 2}) // 1, 2
foo() // TypeError: Cannot read property &apos;x&apos; of undefined
</code></pre><p>上面代码使用了对象的解构赋值默认值，而没有使用函数参数的默认值。只有当函数<code>foo</code>的参数是一个对象时，变量<code>x</code>和<code>y</code>才会通过解构赋值而生成。如果函数<code>foo</code>调用时参数不是对象（或者不能转换成对象），变量<code>x</code>和<code>y</code>就不会生成，从而报错。并且如果参数对象没有<code>y</code>属性，<code>y</code>的默认值<code>5</code>才会生效。</p>
<p>请注意上面例子与下面两种写法的区别</p>
<pre><code>function foo({x=1, y = 5}) {
  console.log(x, y);
}
foo() // TypeError: Cannot match against &apos;undefined&apos; or &apos;null&apos;.解构失败

function foo({x=1, y = 5} = {}) {
  console.log(x, y);
}
foo() // 1 5  双重默认值：首先因为实参为空，所以函数参数默认值{}生效。然后才是解构赋值的默认值生效
</code></pre><h3 id="2-Rest-不定参数"><a href="#2-Rest-不定参数" class="headerlink" title="2. Rest 不定参数"></a>2. Rest 不定参数</h3><p>ES6 引入 <code>rest参数</code>（形式为<code>...变量名</code>），用于获取函数的多余参数，<code>rest参数</code>搭配的变量是一个数组，该变量将多余的参数放入数组中。用来取代额外的<code>arguments</code>对象了。</p>
<pre><code>// arguments变量的写法
function sortNumbers() {
    return Array.prototype.slice.call(arguments).sort();
}  
// rest参数的写法
let sortNumbers = (...numbers) =&gt; numbers.sort();
</code></pre><p>利用 <code>rest参数</code>，可以向该函数传入任意数目的参数。下面这个例子中，其中<code>…x</code>代表了所有传入<code>add</code>函数的参数。</p>
<pre><code>//将所有参数相加的函数
function add(...x){
   return x.reduce((m, n)=&gt; m + n);
} 
console.log(add(1,2,3));//输出：6
console.log(add(1,2,3,4,5));//输出：15                                              
</code></pre><blockquote>
<p><code>rest参数</code>中的变量代表一个数组，所以数组特有的方法都可以用于这个变量。<br><code>rest参数</code>之后不能再有其他参数（即,只能是最后一个参数），否则会报错。<br>一个函数声明只能允许有一个 <code>rest参数</code></p>
</blockquote>
<h3 id="3-箭头函数"><a href="#3-箭头函数" class="headerlink" title="3. 箭头函数"></a>3. 箭头函数</h3><p>我们知道在JS中回调是经常的事，而一般回调又以匿名函数的形式出现，每次都需要写一个<code>function(){}</code>甚是繁琐。当引入箭头操作符<code>=&gt;</code>后可以方便地写回调了。</p>
<p>它简化了函数的书写。操作符左边为输入的参数，而右边则是进行的操作以及返回的值。即， <code>Inputs =&gt; outputs</code>。</p>
<pre><code>let array = [1, 2, 3];

//传统写法
array.forEach(function(v) {
    console.log(v);
});

//ES6
//使用函数体形式
array.forEach(v =&gt; {
    console.log(v)
});
// 或者直接使用更简洁的表达式
array.forEach(v =&gt; console.log(v));    
</code></pre><p>如果箭头函数不需要参数或需要多个参数，就使用一个圆括号代表参数部分。</p>
<pre><code>var f = () =&gt; 5;
var sum = (num1, num2) =&gt; num1 + num2;
</code></pre><p>除了上面的写法的改变，剪头函数使用<code>this</code>时也和我们以前大不相同：以前我们使用闭包，<code>this</code>总是预期之外地产生改变。而箭头函数的迷人之处在于，<code>this</code>的指向是固定的。身处箭头函数体内的<code>this</code>对象，就是定义时所在的对象，而不是使用时所在的对象。</p>
<p>举个例子，实现一个功能，点击某个按钮之后，调用当前模块的<code>sendData()</code>方法：</p>
<p>首先看看ES5中的处理方式</p>
<pre><code>var polyglot = {
    name : &quot;feng&quot;,
    fruits : [&quot;apple&quot;, &quot;orange&quot;, &quot;watermelon&quot;],
    introduce : function () {
        const self = this;
        this.fruits.forEach(function(item) {
            console.log(this)
            console.log(&quot;My name is &quot; + self.name + &quot;, I eat &quot; + item + &quot;.&quot;);
        });
    }
}

polyglot.introduce();
</code></pre><p>在<code>introduce</code>里, <code>this.name</code>是<code>undefined</code>(浏览器环境中<code>forEach</code>的匿名回调中<code>this</code>指向<code>window</code>)。在回调函数外面，也就是<code>forEach</code>中， 它指向了<code>polyglot</code>对象。在这种情形下我们总是希望在函数内部<code>this</code>和函数外部的<code>this</code>指向同一个对象。在ES6中就不需要用 <code>_this = this</code>完成这个需求</p>
<pre><code>let polyglot = {
    name : &quot;feng&quot;,
    fruits : [&quot;apple&quot;, &quot;orange&quot;, &quot;watermelon&quot;],
    introduce : function () {
        this.fruits.forEach((item) =&gt; {
            console.log(&quot;My name is &quot; + this.name + &quot;, I eat &quot; + item + &quot;.&quot;);
        });
    }
}
</code></pre><p>再看个例子，来验证一下(需在浏览器环境验证)</p>
<pre><code>function foo() {
  setTimeout(() =&gt; {
    console.log(&apos;id:&apos;, this.id);
  }, 100);
}

var id = 21;

foo.call({ id: 42 });
// id: 42
</code></pre><p>上面代码中，<code>setTimeout</code>的参数是一个箭头函数，这个箭头函数的定义生效是在<code>foo</code>函数生成时，而它的真正执行要等到<code>100</code>毫秒后。如果是普通函数，执行时<code>this</code>应该指向全局对象<code>window</code>，这时应该输出<code>21</code>。但是，箭头函数导致<code>this</code>总是指向函数定义生效时所在的对象（本例是<code>{id: 42}</code>），所以输出的是<code>42</code></p>
<p>本质上来说，<code>this</code>指向的固定化，并不是因为箭头函数内部有绑定<code>this</code>的机制，实际原因是箭头函数根本没有自己的<code>this</code>，导致内部的<code>this</code>就是外层代码块的<code>this</code>。正是因为它没有<code>this</code>，所以也就不能用作构造函数</p>
<blockquote>
<p>1.简单的、单行的、不会复用的函数，建议采用箭头函数。如果函数体较为复杂，行数较多，还是应该采用传统的函数写法。而且如果箭头函数有多个参数，必须用圆括号包裹<br>2.不可以使用<code>arguments</code>对象，该对象在函数体内不存在，外层函数的对应变量<br>3.由于箭头函数没有自己的<code>this</code>，所以当然也就不能用<code>call()</code>、<code>apply()</code>、<code>bind()</code>这些方法去改变<code>this</code>的指向</p>
</blockquote>
<h2 id="五、数组扩展"><a href="#五、数组扩展" class="headerlink" title="五、数组扩展"></a>五、数组扩展</h2><h3 id="1-扩展运算符…"><a href="#1-扩展运算符…" class="headerlink" title="1. 扩展运算符…"></a>1. 扩展运算符…</h3><p>扩展运算符（spread）是三个点（…），它好比 <code>rest参数</code>的逆运算。<code>rest参数</code>将一个参数转换成数组，而本文中的扩展运算符则负责将一个数组转为用逗号分隔的参数序列。</p>
<pre><code>...[1, 2, 3]
// 1 2 3
1, ...[2, 3, 4], 5
// 1 2 3 4 5
[...document.querySelectorAll(&apos;div&apos;)]
// [&lt;div&gt;, &lt;div&gt;, &lt;div&gt;]

var arr1 = [&apos;a&apos;, &apos;b&apos;];
var arr2 = [&apos;c&apos;];
[...arr1, ...arr2]// [ &apos;a&apos;, &apos;b&apos;, &apos;c&apos; ]
</code></pre><p>下面看几个实际使用案例</p>
<ul>
<li><p>使用扩展运算符拷贝数组</p>
<pre><code>// bad
const len = items.length;
const itemsCopy = [];
let i;

for (i = 0; i &lt; len; i++) {
 itemsCopy[i] = items[i];
}

// good
const itemsCopy = [...items];
</code></pre></li>
<li><p>替代数组的 <code>apply</code>方法<br>原来在ES5中，因为方法或者函数不支持数组参数, 如<code>Math.max/Array.push()</code>,而必须使用<code>apply(array)</code>的场景，都可以直接使用扩展运算符 …</p>
<pre><code>// ES5 的写法
function f(x, y, z) {
  // ...
}
var args = [0, 1, 2];
f.apply(null, args);

// ES6的写法
function f(x, y, z) {
  // ...
}
var args = [0, 1, 2];
f(...args);

var myArray = [1, 2, 3, 4];
Math.max(myArray); //error
Math.max.apply(Math, myArray);// 4，ES5写法
Math.max(...myArray);//4,ES6写法
</code></pre></li>
</ul>
<ul>
<li><p>与解构赋值结合</p>
<pre><code>let test = [1,2,3]
let [a, ...rest] = test;
a //1
</code></pre></li>
</ul>
<blockquote>
<p>如果将扩展运算符用于数组赋值，只能放在参数的最后一位，否则会报错</p>
</blockquote>
<h3 id="2-Array-from"><a href="#2-Array-from" class="headerlink" title="2. Array.from"></a>2. Array.from</h3><p><code>Array.from()</code>可以将各种值转为真正的数组，并且还提供map功能。这实际上意味着，只要有一个原始的数据结构，你就可以先对它的值进行处理，然后转成规范的数组结构，进而就可以使用数量众多的数组方法。</p>
<pre><code>let arrayLike = {
    &apos;0&apos;: &apos;a&apos;,
    &apos;1&apos;: &apos;b&apos;,
    &apos;2&apos;: &apos;c&apos;,
    length: 3
};

// ES5的写法
var arr1 = [].slice.call(arrayLike); // [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;]

// ES6的写法
let arr2 = Array.from(arrayLike); // [&apos;a&apos;, &apos;b&apos;, &apos;c&apos;]
</code></pre><p>还有，在查找一组DOM节点时</p>
<pre><code>const foo = document.querySelectorAll(&apos;.foo&apos;);
const nodes = Array.from(foo);
</code></pre><p>还有，上文说过使用<code>rest参数</code>将参数转换成数组，从而避免使用<code>arguments</code>对象。因为<code>arguments</code>是类数组对象，所以还可以通过<code>Array.from</code>来完成转换工作。</p>
<pre><code>function foo() {
  var args = Array.from(arguments);
  // ...
}
</code></pre><p><code>Array.from</code>的第二个参数，作用类似于数组的<code>map</code>方法，用来对每个元素进行处理，将处理后的值放入返回的数组。</p>
<pre><code>Array.from(arrayLike, x =&gt; x * x);
// 等同于
Array.from(arrayLike).map(x =&gt; x * x);

Array.from([1, 2, 3], (x) =&gt; x * x)
// [1, 4, 9]


Array.from({ length: 2 }, () =&gt; &apos;jack&apos;)
// [&apos;jack&apos;, &apos;jack&apos;]
</code></pre><blockquote>
<p>类数组对象本质特征只有一点：任何有<code>length</code>属性的对象。<br><code>Array.from({ length: 3 });// [ undefined, undefined, undefined ]</code></p>
</blockquote>
<h3 id="3-fill"><a href="#3-fill" class="headerlink" title="3. fill"></a>3. fill</h3><p><code>fill</code>方法使用给定值，填充一个数组。该方法用于空数组的初始化非常方便。要注意，数组中已有的元素，会被全部抹去。</p>
<pre><code>[&apos;a&apos;, &apos;b&apos;, &apos;c&apos;].fill(7)
// [7, 7, 7]

new Array(3).fill(7)
// [7, 7, 7]
</code></pre><h2 id="六、对象扩展"><a href="#六、对象扩展" class="headerlink" title="六、对象扩展"></a>六、对象扩展</h2><h3 id="1-对象属性的简写"><a href="#1-对象属性的简写" class="headerlink" title="1. 对象属性的简写"></a>1. 对象属性的简写</h3><p>如果对象的键值和变量名是一致的，ES6允许仅用变量名来初始化这个对象，而不是定义冗余的键值对。这时，属性名为变量名, 属性值为变量的值</p>
<pre><code>var foo = &apos;foo&apos;;
var bar = &apos;bar&apos;;
var baz = {
    foo,
    bar
};
// 等同于
var baz = {
    foo: foo,
    bar: bar
};
</code></pre><h3 id="2-对象方法的简写"><a href="#2-对象方法的简写" class="headerlink" title="2 对象方法的简写"></a>2 对象方法的简写</h3><pre><code>var o = {
  method(name) {
    return &quot;Hello!&quot; + name;
  }
};

// 等同于
var o = {
  method: function(name) {
    return &quot;Hello!&quot; + name;
  }
};
</code></pre><h3 id="3-对象导出属性的简写"><a href="#3-对象导出属性的简写" class="headerlink" title="3. 对象导出属性的简写"></a>3. 对象导出属性的简写</h3><pre><code>module.exports = { getItem, setItem, clear };
// 等同于
module.exports = {
  getItem: getItem,
  setItem: setItem,
  clear: clear
};
</code></pre><h3 id="4-新增：object-assign"><a href="#4-新增：object-assign" class="headerlink" title="4 新增：object.assign()"></a>4 新增：object.assign()</h3><p>用于对象的合并，将源对象的所有可枚举属性，复制到目标对象。方法的第一个参数是目标对象，后面的参数都是源对象。如果目标对象与源对象有同名属性，或多个源对象有同名属性，则后面的属性会覆盖前面的属性。</p>
<pre><code>var target = { a: 1, b: 1 };
var source1 = { b: 2, c: 2 };
var source2 = { c: 3 };

Object.assign(target, source1, source2);
target // {a:1, b:2, c:3}
</code></pre><p>需要注意的是，这个方法施行的不是类似<code>merge</code>的操作，而是简单的同名<code>key</code>的的简单覆盖,而不是添加</p>
<pre><code>var target = { 
    a: 1, 
    b: {
        key: {
            inner_key:0
        }
    }
};
var source1 = { 
    b: {
        key:{
            inner_key:1,
            inner_key2:2,
            inner_key3:3
        }
    } 
};

Object.assign(target, source1);
// target { a: 1, b: { key: { inner_key: 1, inner_key2: 2, inner_key3: 3 } } }
</code></pre><blockquote>
<p><code>Object.assign</code>方法实行的是浅拷贝，而不是深拷贝。也就是说，如果源对象某个属性的值是对象，那么目标对象拷贝得到的是这个对象的引用。这个对象的任何变化，都会反映到目标对象上面。</p>
</blockquote>
<h3 id="5-Object-setPrototypeOf"><a href="#5-Object-setPrototypeOf" class="headerlink" title="5. Object.setPrototypeOf"></a>5. Object.setPrototypeOf</h3><p>用来设置一个对象的<code>prototype</code>对象，返回参数对象本身。它是 ES6 正式推荐的设置原型对象的方法。</p>
<pre><code>Object.setPrototypeOf(object, prototype)
</code></pre><p>举一个例子</p>
<pre><code>let proto = {};
let obj = { x: 10 };
Object.setPrototypeOf(obj, proto); // 将proto对象设置为obj的原型

proto.y = 20;
proto.z = 40;

obj.x // 10
obj.y // 20
obj.z // 40
</code></pre><h3 id="6-Object-getPrototypeOf"><a href="#6-Object-getPrototypeOf" class="headerlink" title="6. Object.getPrototypeOf"></a>6. Object.getPrototypeOf</h3><p>该方法与<code>Object.setPrototypeOf</code>方法配套，用于读取一个对象的原型对象。下面是一个例子。</p>
<pre><code>function Rectangle() {
  // ...
}

var rec = new Rectangle();

Object.getPrototypeOf(rec) === Rectangle.prototype
// true

Object.setPrototypeOf(rec, Object.prototype);
Object.getPrototypeOf(rec) === Rectangle.prototype
// false
</code></pre><h3 id="7-Object-keys-，Object-values-，Object-entries"><a href="#7-Object-keys-，Object-values-，Object-entries" class="headerlink" title="7. Object.keys()，Object.values()，Object.entries()"></a>7. Object.keys()，Object.values()，Object.entries()</h3><p><code>Object.keys</code>方法，返回一个数组，成员是参数对象自身的（不含继承的）所有可遍历（enumerable）属性的键名。<br><code>Object.values</code>方法返回一个数组，成员是参数对象自身的（不含继承的）所有可遍历（enumerable）属性的键值。<br><code>Object.entries</code>方法返回一个数组，成员是参数对象自身的（不含继承的）所有可遍历（enumerable）属性的键值对数组。</p>
<pre><code>let {keys, values, entries} = Object;
let obj = { a: 1, b: 2, c: 3 };

for (let key of keys(obj)) {
  console.log(key); // &apos;a&apos;, &apos;b&apos;, &apos;c&apos;
}

for (let value of values(obj)) {
  console.log(value); // 1, 2, 3
}

for (let [key, value] of entries(obj)) {
  console.log([key, value]); // [&apos;a&apos;, 1], [&apos;b&apos;, 2], [&apos;c&apos;, 3]
}
</code></pre><h2 id="七、Classes"><a href="#七、Classes" class="headerlink" title="七、Classes"></a>七、Classes</h2><p>JavaScript 语言中，生成实例对象的传统方法是通过构造函数。下面是一个例子。</p>
<pre><code>function Point(x, y) {
  this.x = x;
  this.y = y;
}

Point.prototype.toString = function () {
  return &apos;(&apos; + this.x + &apos;, &apos; + this.y + &apos;)&apos;;
};

var p = new Point(1, 2);
</code></pre><p>ES6 提供了更接近传统面相对象语言的写法，引入了 Class（类）这个概念，作为对象的模板。通过<code>class</code>关键字，可以定义类。</p>
<pre><code>//定义类
class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
  // 方法之间不需要逗号分隔，加了会报错
  toString() {
    return `${this.x}{this.y}`
  }
}
</code></pre><blockquote>
<p>类必须使用<code>new</code>调用，否则会报错。</p>
</blockquote>
<h3 id="类的静态方法"><a href="#类的静态方法" class="headerlink" title="类的静态方法"></a>类的静态方法</h3><p>所有在类中定义的方法，都会被实例继承。如果在一个方法前，加上<code>static</code>关键字，就表示该方法不会被实例继承，而是直接通过类来调用，这就称为“静态方法”。</p>
<pre><code>class Foo {
  static classMethod() {
    return &apos;hello&apos;;
  }
}

Foo.classMethod() // &apos;hello&apos;

var foo = new Foo();
foo.classMethod()
// TypeError: foo.classMethod is not a function
</code></pre><blockquote>
<p>父类的静态方法，可以被子类继承</p>
</blockquote>
<h3 id="Class的继承"><a href="#Class的继承" class="headerlink" title="Class的继承"></a>Class的继承</h3><p>Class 可以通过<code>extends</code>关键字实现继承，这比 ES5 的通过修改原型链实现继承，要清晰和方便很多。</p>
<pre><code>class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }

  toString() {
    return &apos;(&apos; + this.x + &apos;, &apos; + this.y + &apos;)&apos;;
  }
}

class ColorPoint extends Point {
  constructor(x, y, color) {
    // 调用父类的 constructor(x, y) 
    // 相当于Point.prototype.constructor.call(this,x,y)
    super(x, y); 
    this.color = color;
  }

  toString() {
    return this.color + &apos; &apos; + super.toString(); // 调用父类的toString()
  }
}
</code></pre><p><code>super</code>关键字，它在这里表示父类的构造函数。子类必须在<code>constructor</code>方法中调用<code>super</code>方法，否则新建实例时会报错。这是因为子类没有自己的<code>this</code>对象，而是继承父类的<code>this</code>对象，然后对其进行加工。如果不调用<code>super</code>方法，子类就得不到<code>this</code>对象。</p>
<p>ES5 的继承，实质是先创造子类的实例对象<code>this</code>，然后再将父类的方法添加到<code>this</code>上面（<code>Parent.apply(this)</code>）。而 ES6 的继承机制完全不同，实质是先创造父类的实例对象<code>this</code>（<code>super()</code>方法），然后再用子类的构造函数修改<code>this</code>。</p>
<p><code>Object.getPrototypeOf</code>方法可以用来从子类上获取父类。因此，可以使用这个方法判断，一个类是否继承了另一个类。</p>
<pre><code>Object.getPrototypeOf(ColorPoint) === Point
// true
</code></pre><h2 id="八、Modules（模块）"><a href="#八、Modules（模块）" class="headerlink" title="八、Modules（模块）"></a>八、Modules（模块）</h2><h3 id="使用-import-取代-require"><a href="#使用-import-取代-require" class="headerlink" title="使用 import 取代 require"></a>使用 import 取代 require</h3><pre><code>// bad
const moduleA = require(&apos;moduleA&apos;);
const func1 = moduleA.func1;
const func2 = moduleA.func2;

// good
import { func1, func2 } from &apos;moduleA&apos;;
</code></pre><h3 id="使用-export-取代-module-exports"><a href="#使用-export-取代-module-exports" class="headerlink" title="使用 export 取代 module.exports"></a>使用 export 取代 module.exports</h3><pre><code>// point.js
module &quot;point&quot; {
    export class Point {
        constructor (x, y) {
            public x = x;
            public y = y;
        }
    }
}

// myapp.js
//声明引用的模块
module point from &quot;/point.js&quot;;
//这里可以看出，尽管声明了引用的模块，还是可以通过指定需要的部分进行导入
import Point from &quot;point&quot;;

var origin = new Point(0, 0);
console.log(origin);
</code></pre><hr>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://github.com/airbnb/javascript#ecmascript-6-es-2015-styles" target="_blank" rel="noopener">ES6编程规范</a><br><a href="https://qiutc.me/post/es6-cheatsheet.html#tip" target="_blank" rel="noopener">ES手册传送门</a></p>
<p><img src="/images/image1.png" alt="upload successful"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/10/11/webpack体积优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/11/webpack体积优化/" itemprop="url">
                  webpack体积优化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T15:16:00+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>从webpack文件上来看，主要用到的有entry，output，resolve，module，plugins</p>
<ul>
<li>entry入口<br>用来写入口文件，SPA一般是一个入口。当然也有vendor写在这里。</li>
<li>output出口<br> 主要为webpack经过你设计的规则构建后输出的文件，指定输出位置，文件名等配置。</li>
<li>resolve解析<br> 定制你的解析规则，后面会说到。</li>
<li>module模块<br> 主要是装载器loaders书写的地方，webpack2已经改为rules。</li>
<li>plugins插件</li>
</ul>
<p>详细请看<strong><a href="https://doc.webpack-china.org/configuration" target="_blank" rel="noopener">配置</a></strong></p>
<h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><p>output除了用来指定输出位置外，还有一些hash和chunk的配置。hash是随机生成的，每一次都会改变。chunk这里指的是webpack分割的代码块，webpack在编译过程中会解析内容，通过内容生成chunkhash，chunkhash相对hash来说是相对不变的，我们也是利用这一点来做浏览器缓存。这里webpack提供了hash生成的算法，chunkhash失效时间等配置，一般来说我们不会用到。</p>
<p>主要用到的东西就是path，publicpath，filename，chunkFilename<br>path指的是webpack构建完成后的输出地址<br>publicpath指的是资源的访问地址<br>filename是生成文件的名字<br>chunkFilename非入口的文件名</p>
<h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h3><p>resolve是webpack可定制的解析，他的配置决定了你在require或者import一个包的时候，webpack去哪里找这个文件。<br>resolve.modules指定查找包的文件夹，可用绝对路径和文件名。文件名的查找规则和node_modules查找规则一致。<br>resolve.descriptionFiles指定查找包的描述文件，一般为package.json<br>resolve.mainFields指定描述文件中的入口字段，一般为main</p>
<p>一般的解析就是通过modules查找到包，然后找包内的描述文件package.json,然后根据包内的描述文件入口字段mainFields来引入js文件<br>似乎mainFields指定的字段不支持Array类型，也就是说package.json中的main字段得是个String，这样你需要引入多个文件的时候就需要做个入口文件了。</p>
<h3 id="loader和plugins的区别"><a href="#loader和plugins的区别" class="headerlink" title="loader和plugins的区别"></a>loader和plugins的区别</h3><p>其实他们两没有什么可比性，放在这里只是想说明一下他们在webpack中扮演的角色。<br>webpack是一个插件式的架构，采用Tapable事件流。<br>loader其实只是在webpack编译过程中的某一个时期执行，他的作用就是对符合规则的文件进行转换，比如常用的less-loader、css-loader、style-loader，less-loader先将less语法转为css，css-loader支持我们require引用css和处理css内部的import和url，style-loader则是将css文件转为style注入到页面中。loader支持链式调用，前面提到的例子就是将less转为style的一个链式调用。除此之外，各个loader之间是互不影响。<br>loader的调用方式分为三种，分别是命令行调用，内联调用和在配置文件webpack.config.js中配置。个人比较推荐第三种，这样对源码的影响将会是最小的。<br>plugins不同于loader，他贯穿整个webpack编译。利用webpack提供的很多hook，在不同的时期触发相应的操作，功能也多种多样。<br>感兴趣的可以了解一下<a href="http://www.tuicool.com/articles/2Inmeyn" target="_blank" rel="noopener">webpack之loader和plugin简介</a>和<a href="https://lihuanghe.github.io/2016/05/30/webpack-source-analyse.html" target="_blank" rel="noopener">webpack 源码解析</a>。</p>
<h4 id="常用的loader"><a href="#常用的loader" class="headerlink" title="常用的loader"></a>常用的loader</h4><ul>
<li>样式：style-loader、css-loader、less-loader、sass-loader等</li>
<li>文件：raw-loader、file-loader 、url-loader、json-loader等</li>
<li>编译：babel-loader、coffee-loader 、ts-loader等</li>
<li>校验测试：mocha-loader、jshint-loader 、eslint-loader等</li>
</ul>
<h4 id="常用的plugin"><a href="#常用的plugin" class="headerlink" title="常用的plugin"></a>常用的plugin</h4><ul>
<li>DefinePlugin<br>  全局常量定义</li>
<li>UglifyJsPlugin<br>  代码丑化</li>
<li>OccurenceOrderPlugin</li>
<li>HtmlWebpackPlugin<br>  自动生成html5文件</li>
<li>CommonsChunkPlugin<br>  公共代码整合</li>
<li>CompressionWebpackPlugin<br>  gzip压缩</li>
</ul>
<p>详细请看<strong><a href="https://github.com/webpack-contrib/awesome-webpack" target="_blank" rel="noopener">awesome-webpack</a>、<a href="http://www.tuicool.com/articles/2Inmeyn" target="_blank" rel="noopener">webpack之loader和plugin简介</a>、<a href="http://www.css88.com/doc/webpack2/guides/development/" target="_blank" rel="noopener">webpack2.2中文文档</a></strong></p>
<h3 id="webpack执行流程"><a href="#webpack执行流程" class="headerlink" title="webpack执行流程"></a>webpack执行流程</h3><ul>
<li>entry-option<br>初始化option</li>
<li>run<br>开始编译</li>
<li>make<br>从entry开始递归的分析依赖，对每个依赖模块进行build</li>
<li>before-resolve - after-resolve<br>对其中一个模块位置进行解析</li>
<li>build-module<br>开始构建 (build) 这个module,这里将使用文件对应的loader加载</li>
<li>normal-module-loader<br>对用loader加载完成的module(是一段js代码)进行编译,用 <a href="https://github.com/ternjs/acorn" target="_blank" rel="noopener">acorn</a> 编译,生成ast抽象语法树。</li>
<li>program<br>开始对ast进行遍历，当遇到require等一些调用表达式时，触发call require<br>事件的handler执行，收集依赖，并。如：AMDRequireDependenciesBlockParserPlugin等</li>
<li>seal<br>所有依赖build完成，下面将开始对chunk进行优化，比如合并,抽取公共模块,加hash</li>
<li>bootstrap<br>生成启动代码<br>emit<br>把各个chunk输出到结果文件</li>
</ul>
<h2 id="包体积优化"><a href="#包体积优化" class="headerlink" title="包体积优化"></a>包体积优化</h2><h3 id="包分析"><a href="#包分析" class="headerlink" title="包分析"></a>包分析</h3><p>通过插件<a href="https://www.npmjs.com/package/webpack-bundle-analyzer" target="_blank" rel="noopener">webpack-bundle-analyzer</a>进行分析。</p>
<p><code>npm i webpack-bundle-analyzer --save</code></p>
<p>这个插件在使用后会开启一个网页，一般为localhost:8888，当然这个可以配置。通过图像展示我们打包的每个文件组成，各个部分体积，总体积等一些信息。</p>
<p>详细的配置可以查看npm上面的文档，这里我也是用了npm的案例配置。</p>
<p><strong>PS：</strong>个人认为优化还是要基于对项目的熟悉上，否则可能会无从下手。</p>
<h3 id="lodash-优化"><a href="#lodash-优化" class="headerlink" title="lodash 优化"></a>lodash 优化</h3><p><code>npm install babel-plugin-lodash lodash-webpack-plugin --save</code></p>
<pre><code>const LodashModuleReplacementPlugin = require(&apos;lodash-webpack-plugin&apos;);

const config = {
  plugins: [
    new LodashModuleReplacementPlugin({
      path: true,
      flattening: true
    })
  ]
};

.babelrc
plugins: [&apos;transform-runtime&apos;, &apos;lodash&apos;],
</code></pre><h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p><code>npm i bundle-loader --save</code></p>
<pre><code>require(&quot;bundle-loader?lazy&amp;name=my-chunk!./file.js&quot;);
OR
import XXX from &quot;bundle-loader?lazy&amp;[name=[name]]!./file.js&quot;
</code></pre><h3 id="CDN优化"><a href="#CDN优化" class="headerlink" title="CDN优化"></a>CDN优化</h3><p>CDN优化依赖一个包管理器Bower</p>
<p>Bower算是一个很老的前端包管理器，虽说它叫包管理器，其实他只是提供了扁平化的下载和记录功能。</p>
<p>目前Bower已宣告终止开发，前端模块管理全面移向npm。</p>
<p>这里npm3已经号称是JavaScript的包管理器，而不仅仅是node的包管理器了。：）</p>
<p>####　安装Bower</p>
<p><code>npm i -g bower</code></p>
<h4 id="Bower部分命令"><a href="#Bower部分命令" class="headerlink" title="Bower部分命令"></a>Bower部分命令</h4><p>bower的命令和npm大同小异，以下是几个常用的命令：</p>
<ul>
<li>初始化，生成bower.json文件，功效和package.json差不多<br><code>bower init</code></li>
<li>查找包，当然也可以通过官网查找<br><code>bower search XXX</code></li>
<li>安装包，规则和npm一致，可以下载对应版本的包<br><code>bower install XXX@XX --save</code></li>
</ul>
<h4 id="webpack和bower的连接"><a href="#webpack和bower的连接" class="headerlink" title="webpack和bower的连接"></a>webpack和bower的连接</h4><p>通过插件<a href="https://www.npmjs.com/package/bower-webpack-plugin" target="_blank" rel="noopener">bower-webpack-plugin</a>进行webpack和bower的连接。</p>
<p><code>npm i bower-webpack-plugin --save</code></p>
<p>这里其实他做的很类似resolve的alise，就是通过插件指定了require/import一个bower包的时候的地址和文件。</p>
<p>以下是它的配置：</p>
<pre><code>var BowerWebpackPlugin = require(&quot;bower-webpack-plugin&quot;);
new BowerWebpackPlugin({
  modulesDirectories: [&quot;bower_components&quot;],
  manifestFiles:&quot;bower.json&quot;,
  excludes: /.*\.less/
}),
</code></pre><p>通过modulesDirectories指向bower的依赖文件夹，manifestFiles指向入口文件。这里一般配置一般都是固定的，详细的配置可以查看NPM文档。<br>下面是bootstrap的bower.json文件，可以看出它是通过main字段来引入对应文件的。</p>
<p>bower包的引入和正常的npm包一样引入，通过import或者require，测试发现还是require效果好一点，少一点坑。</p>
<p>在升级到webpack2之后，发现这个插件已经不支持了，转采用<a href="https://github.com/codewizz/bower-resolve-webpack-plugin" target="_blank" rel="noopener">bower-resolve-webpack-plugin</a><br>它的配置参考github文档，发现只能加载js文件，废弃！不过可以借鉴一下它写插件</p>
<h3 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h3><p>bootstrap-loader用来解决bootstrap加载<br>查找网上webpack引入bootstrap一致推荐bootstrap-loader，测试后发现引入这个东西bootstrap会占用将近150kb的空间，记录一下<br>vendor占用544kb<br>app占用158kb</p>
<p>安装<br><code>npm install bootstrap-loader --save</code><br><code>npm install bootstrap-sass --save</code><br><code>npm install css-loader node-sass resolve-url-loader sass-loader style-loader url-loader --save</code></p>
<p>加载<br> <code>require(&#39;bootstrap-loader&#39;)</code></p>
<p>详细请看<a href="http://www.cnblogs.com/liuyt/p/5708508.html" target="_blank" rel="noopener">如何把bootstrap用webpack打包</a></p>
<p>另一种办法是通过bower引入，但是bower中bootstrap给的入口文件有一个less，无法解决，只能修改less为css。这样bootstrap占用会只有不到50kb<br>vendor占用390kb<br>app占用190kb</p>
<hr>
<h2 id="webpack2-tree-shaking"><a href="#webpack2-tree-shaking" class="headerlink" title="webpack2 tree-shaking"></a>webpack2 tree-shaking</h2><p>node的import语法允许我们只引入我们需要的方法，这对于js的内存占用是一种极大的提升。同时在webpack打包的时候也利用了这种特性，只打包我们引入的方法。但是这一点和babel的转码会有冲突，具体原因看这里如下：</p>
<blockquote>
<p>tree-shaking 是指借助es6 import export 语法静态性的特点来删掉export但是没有import过的东西，babel会在编译转化es6代码时把import export转换为cmd的module.export<br>原文请看<a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html" target="_blank" rel="noopener">Tree-shaking with webpack 2 and Babel 6</a>。</p>
</blockquote>
<p>我们为了利用webpack2的这种特性，需要做一些配置，见原文。<br>经过测试，我发现这个特性能减少的包体积量几乎可以忽略不计。难怪会有此讨论-&gt;<a href="https://www.zhihu.com/question/41922432" target="_blank" rel="noopener">如何评价 Webpack 2 新引入的 Tree-shaking 代码优化技术？</a></p>
<h2 id="打包速度优化"><a href="#打包速度优化" class="headerlink" title="打包速度优化"></a>打包速度优化</h2><p>flag</p>
<h2 id="webpack2入坑"><a href="#webpack2入坑" class="headerlink" title="webpack2入坑"></a>webpack2入坑</h2><ol>
<li>入口和出口其实改动不大</li>
<li>resolve改动会大一点，不过因为我们不经常用，所以不用太关注，这里需要注意的就是以下几点：<ul>
<li>resolve.extensions配置，数组不需要在第一位加空字符串了</li>
<li>resolve.root, resolve.fallback, resolve.modulesDirectories合并为resolve.modules</li>
</ul>
</li>
<li>module语法改动<ul>
<li>module.loaders改为module.rules</li>
<li>不再支持简写loader，也就是说css以后要写成css-loader</li>
<li>链式调用style!css!less改为use[]</li>
</ul>
</li>
<li>plugins改动<br> 这个就需要看各个插件的支持了，有部分插件是只支持1不支持2的，还有webpack内置插件的有部分语法改动，需要用的时候查看。改动最大的就是extract-text-webpack-plugin，不升级无法使用。</li>
</ol>
<p>webpack2主要的变更就是对ES6的支持更好了，当然我升级到2以后除了踩了很多语法坑和插件坑之外，并没有体验到所谓的性能提升，很尴尬。利用了tree shaking特性后包的体积也并没有减小多少。只能说webpack2比1更大的规范化，并且目前webpack已经升级到了3.5，语法已经稳定，市面上的各类资料和插件也都是webpack2更完善、支持更好。</p>
<p><strong>传送门</strong></p>
<p><a href="http://www.tuicool.com/articles/2Inmeyn" target="_blank" rel="noopener">webpack之loader和plugin简介</a></p>
<p><a href="https://lihuanghe.github.io/2016/05/30/webpack-source-analyse.html" target="_blank" rel="noopener">webpack 源码解析</a></p>
<p><a href="https://doc.webpack-china.org/" target="_blank" rel="noopener">webpack中文官网</a></p>
<p><a href="http://blog.csdn.net/keliyxyz/article/details/51571386" target="_blank" rel="noopener">webpack入门（一）——webpack 介绍</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIyMjE0ODQ0OQ==&amp;mid=402764877&amp;idx=1&amp;sn=aa40a80bb1920a80fc187e8df99c4824" target="_blank" rel="noopener">[译] Webpack 2 有哪些新东西</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/06/15/Git 使用入门/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/15/Git 使用入门/" itemprop="url">
                  Git 使用入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-15T15:17:48+08:00">
                2017-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Git-客户端安装"><a href="#Git-客户端安装" class="headerlink" title="Git 客户端安装"></a>Git 客户端安装</h1><p>讲真，这个对大家应该都没有难度。。。提供下载地址，自己玩</p>
<h2 id="Mac-安装"><a href="#Mac-安装" class="headerlink" title="Mac 安装"></a>Mac 安装</h2><ul>
<li>图形化的Git安装工具 <a href="https://sourceforge.net/projects/git-osx-installer/files/" target="_blank" rel="noopener">点我</a></li>
<li><a href="https://brew.sh/index_zh-cn.html" target="_blank" rel="noopener">HomeBrew</a> 安装 </li>
</ul>
<h2 id="Windows安装"><a href="#Windows安装" class="headerlink" title="Windows安装"></a>Windows安装</h2><p><a href="https://git-for-windows.github.io/" target="_blank" rel="noopener">Git For Windows</a>  提供命令行 Git Bash 和图形化 Git GUI</p>
<hr>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/06/15/Git 使用入门/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/06/15/Git 使用分享/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/15/Git 使用分享/" itemprop="url">
                  Git 使用分享
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-15T15:03:48+08:00">
                2017-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Git-几个重要的概念"><a href="#Git-几个重要的概念" class="headerlink" title="Git 几个重要的概念"></a>Git 几个重要的概念</h2><ul>
<li>本地仓库<br>Git 中大部分都是针对本地仓库的操作，完全不用担心污染远程仓库，比如 git add ，git commit ，git reset，checkout 等等。</li>
<li>远程仓库<br>服务端的代码仓库，用于多人协作开发。。。每个开发人员的本地仓库都是一份完整的远程仓库备份。</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/06/15/Git 使用分享/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://jhmobile.github.io/2017/05/04/Android ButterKnife 框架使用详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jinhui-mobile">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="金汇移动开发团队">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/04/Android ButterKnife 框架使用详解/" itemprop="url">
                  ButterKnife 框架使用详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-04T15:00:48+08:00">
                2017-05-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p>findViewById 是每一个 Android 开发者的必经之路，同样也是噩梦。为了提高开发效率，准备在项目中使用 ButterKnife（PS：感谢JakeWharton大神），本文基于8.5.1 版本官方文档翻译，不同的版本在用法上可能会差异，实际使用时，请参考官网文档。<br><a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="noopener">Github 地址</a><br><a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="noopener">官方文档</a></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/05/04/Android ButterKnife 框架使用详解/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="jinhui-mobile">
          <p class="site-author-name" itemprop="name">jinhui-mobile</p>
           
              <p class="site-description motion-element" itemprop="description">stay hungry stay foolish</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/jhmobile/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jinhui-mobile</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
